{"version":3,"file":"point-of-sale.min.js","sources":["../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_item_selector.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_item_cart.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_item_details.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_number_pad.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_payment.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_past_order_list.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_past_order_summary.js","../../../apps/erpnext/erpnext/selling/page/point_of_sale/pos_controller.js"],"sourcesContent":["import onScan from 'onscan.js';\n\nerpnext.PointOfSale.ItemSelector = class {\n\t// eslint-disable-next-line no-unused-vars\n\tconstructor({ frm, wrapper, events, pos_profile, settings }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\t\tthis.pos_profile = pos_profile;\n\t\tthis.hide_images = settings.hide_images;\n\t\tthis.auto_add_item = settings.auto_add_item_to_cart;\n\n\t\tthis.inti_component();\n\t}\n\n\tinti_component() {\n\t\tthis.prepare_dom();\n\t\tthis.make_search_bar();\n\t\tthis.load_items_data();\n\t\tthis.bind_events();\n\t\tthis.attach_shortcuts();\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"items-selector\">\n\t\t\t\t<div class=\"filter-section\">\n\t\t\t\t\t<div class=\"label\">${__('All Items')}</div>\n\t\t\t\t\t<div class=\"search-field\"></div>\n\t\t\t\t\t<div class=\"item-group-field\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"items-container\"></div>\n\t\t\t</section>`\n\t\t);\n\n\t\tthis.$component = this.wrapper.find('.items-selector');\n\t\tthis.$items_container = this.$component.find('.items-container');\n\t}\n\n\tasync load_items_data() {\n\t\tif (!this.item_group) {\n\t\t\tconst res = await frappe.db.get_value(\"Item Group\", {lft: 1, is_group: 1}, \"name\");\n\t\t\tthis.parent_item_group = res.message.name;\n\t\t}\n\t\tif (!this.price_list) {\n\t\t\tconst res = await frappe.db.get_value(\"POS Profile\", this.pos_profile, \"selling_price_list\");\n\t\t\tthis.price_list = res.message.selling_price_list;\n\t\t}\n\n\t\tthis.get_items({}).then(({message}) => {\n\t\t\tthis.render_item_list(message.items);\n\t\t});\n\t}\n\n\tget_items({start = 0, page_length = 40, search_term=''}) {\n\t\tconst doc = this.events.get_frm().doc;\n\t\tconst price_list = (doc && doc.selling_price_list) || this.price_list;\n\t\tlet { item_group, pos_profile } = this;\n\n\t\t!item_group && (item_group = this.parent_item_group);\n\n\t\treturn frappe.call({\n\t\t\tmethod: \"erpnext.selling.page.point_of_sale.point_of_sale.get_items\",\n\t\t\tfreeze: true,\n\t\t\targs: { start, page_length, price_list, item_group, search_term, pos_profile },\n\t\t});\n\t}\n\n\n\trender_item_list(items) {\n\t\tthis.$items_container.html('');\n\n\t\titems.forEach(item => {\n\t\t\tconst item_html = this.get_item_html(item);\n\t\t\tthis.$items_container.append(item_html);\n\t\t});\n\t}\n\n\tget_item_html(item) {\n\t\tconst me = this;\n\t\t// eslint-disable-next-line no-unused-vars\n\t\tconst { item_image, serial_no, batch_no, barcode, actual_qty, stock_uom, price_list_rate } = item;\n\t\tconst precision = flt(price_list_rate, 2) % 1 != 0 ? 2 : 0;\n\t\tlet indicator_color;\n\t\tlet qty_to_display = actual_qty;\n\n\t\tif (item.is_stock_item) {\n\t\t\tindicator_color = (actual_qty > 10 ? \"green\" : actual_qty <= 0 ? \"red\" : \"orange\");\n\n\t\t\tif (Math.round(qty_to_display) > 999) {\n\t\t\t\tqty_to_display = Math.round(qty_to_display)/1000;\n\t\t\t\tqty_to_display = qty_to_display.toFixed(1) + 'K';\n\t\t\t}\n\t\t} else {\n\t\t\tindicator_color = '';\n\t\t\tqty_to_display = '';\n\t\t}\n\n\t\tfunction get_item_image_html() {\n\t\t\tif (!me.hide_images && item_image) {\n\t\t\t\treturn `<div class=\"item-qty-pill\">\n\t\t\t\t\t\t\t<span class=\"indicator-pill whitespace-nowrap ${indicator_color}\">${qty_to_display}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"flex items-center justify-center h-32 border-b-grey text-6xl text-grey-100\">\n\t\t\t\t\t\t\t<img\n\t\t\t\t\t\t\t\tonerror=\"cur_pos.item_selector.handle_broken_image(this)\"\n\t\t\t\t\t\t\t\tclass=\"h-full\" src=\"${item_image}\"\n\t\t\t\t\t\t\t\talt=\"${frappe.get_abbr(item.item_name)}\"\n\t\t\t\t\t\t\t\tstyle=\"object-fit: cover;\">\n\t\t\t\t\t\t</div>`;\n\t\t\t} else {\n\t\t\t\treturn `<div class=\"item-qty-pill\">\n\t\t\t\t\t\t\t<span class=\"indicator-pill whitespace-nowrap ${indicator_color}\">${qty_to_display}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"item-display abbr\">${frappe.get_abbr(item.item_name)}</div>`;\n\t\t\t}\n\t\t}\n\n\t\treturn (\n\t\t\t`<div class=\"item-wrapper\"\n\t\t\t\tdata-item-code=\"${escape(item.item_code)}\" data-serial-no=\"${escape(serial_no)}\"\n\t\t\t\tdata-batch-no=\"${escape(batch_no)}\" data-uom=\"${escape(stock_uom)}\"\n\t\t\t\tdata-rate=\"${escape(price_list_rate || 0)}\"\n\t\t\t\ttitle=\"${item.item_name}\">\n\n\t\t\t\t${get_item_image_html()}\n\n\t\t\t\t<div class=\"item-detail\">\n\t\t\t\t\t<div class=\"item-name\">\n\t\t\t\t\t\t${frappe.ellipsis(item.item_name, 18)}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"item-rate\">${format_currency(price_list_rate, item.currency, precision) || 0}</div>\n\t\t\t\t</div>\n\t\t\t</div>`\n\t\t);\n\t}\n\n\thandle_broken_image($img) {\n\t\tconst item_abbr = $($img).attr('alt');\n\t\t$($img).parent().replaceWith(`<div class=\"item-display abbr\">${item_abbr}</div>`);\n\t}\n\n\tmake_search_bar() {\n\t\tconst me = this;\n\t\tconst doc = me.events.get_frm().doc;\n\t\tthis.$component.find('.search-field').html('');\n\t\tthis.$component.find('.item-group-field').html('');\n\n\t\tthis.search_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Search'),\n\t\t\t\tfieldtype: 'Data',\n\t\t\t\tplaceholder: __('Search by item code, serial number or barcode')\n\t\t\t},\n\t\t\tparent: this.$component.find('.search-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.item_group_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Item Group'),\n\t\t\t\tfieldtype: 'Link',\n\t\t\t\toptions: 'Item Group',\n\t\t\t\tplaceholder: __('Select item group'),\n\t\t\t\tonchange: function() {\n\t\t\t\t\tme.item_group = this.value;\n\t\t\t\t\t!me.item_group && (me.item_group = me.parent_item_group);\n\t\t\t\t\tme.filter_items();\n\t\t\t\t},\n\t\t\t\tget_query: function () {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tquery: 'erpnext.selling.page.point_of_sale.point_of_sale.item_group_query',\n\t\t\t\t\t\tfilters: {\n\t\t\t\t\t\t\tpos_profile: doc ? doc.pos_profile : ''\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t},\n\t\t\tparent: this.$component.find('.item-group-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.search_field.toggle_label(false);\n\t\tthis.item_group_field.toggle_label(false);\n\n\t\tthis.attach_clear_btn();\n\t}\n\n\tattach_clear_btn() {\n\t\tthis.search_field.$wrapper.find('.control-input').append(\n\t\t\t`<span class=\"link-btn\" style=\"top: 2px;\">\n\t\t\t\t<a class=\"btn-open no-decoration\" title=\"${__(\"Clear\")}\">\n\t\t\t\t\t${frappe.utils.icon('close', 'sm')}\n\t\t\t\t</a>\n\t\t\t</span>`\n\t\t);\n\n\t\tthis.$clear_search_btn = this.search_field.$wrapper.find('.link-btn');\n\n\t\tthis.$clear_search_btn.on('click', 'a', () => {\n\t\t\tthis.set_search_value('');\n\t\t\tthis.search_field.set_focus();\n\t\t});\n\t}\n\n\tset_search_value(value) {\n\t\t$(this.search_field.$input[0]).val(value).trigger(\"input\");\n\t}\n\n\tbind_events() {\n\t\tconst me = this;\n\t\twindow.onScan = onScan;\n\n\t\tonScan.decodeKeyEvent = function (oEvent) {\n\t\t\tvar iCode = this._getNormalizedKeyNum(oEvent);\n\t\t\tswitch (true) {\n\t\t\t\tcase iCode >= 48 && iCode <= 90: // numbers and letters\n\t\t\t\tcase iCode >= 106 && iCode <= 111: // operations on numeric keypad (+, -, etc.)\n\t\t\t\tcase (iCode >= 160 && iCode <= 164) || iCode == 170: // ^ ! # $ *\n\t\t\t\tcase iCode >= 186 && iCode <= 194: // (; = , - . / `)\n\t\t\t\tcase iCode >= 219 && iCode <= 222: // ([ \\ ] ')\n\t\t\t\tcase iCode == 32: // spacebar\n\t\t\t\t\tif (oEvent.key !== undefined && oEvent.key !== '') {\n\t\t\t\t\t\treturn oEvent.key;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar sDecoded = String.fromCharCode(iCode);\n\t\t\t\t\tswitch (oEvent.shiftKey) {\n\t\t\t\t\t\tcase false: sDecoded = sDecoded.toLowerCase(); break;\n\t\t\t\t\t\tcase true: sDecoded = sDecoded.toUpperCase(); break;\n\t\t\t\t\t}\n\t\t\t\t\treturn sDecoded;\n\t\t\t\tcase iCode >= 96 && iCode <= 105: // numbers on numeric keypad\n\t\t\t\t\treturn 0 + (iCode - 96);\n\t\t\t}\n\t\t\treturn '';\n\t\t};\n\n\t\tonScan.attachTo(document, {\n\t\t\tonScan: (sScancode) => {\n\t\t\t\tif (this.search_field && this.$component.is(':visible')) {\n\t\t\t\t\tthis.search_field.set_focus();\n\t\t\t\t\tthis.set_search_value(sScancode);\n\t\t\t\t\tthis.barcode_scanned = true;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.$component.on('click', '.item-wrapper', function() {\n\t\t\tconst $item = $(this);\n\t\t\tconst item_code = unescape($item.attr('data-item-code'));\n\t\t\tlet batch_no = unescape($item.attr('data-batch-no'));\n\t\t\tlet serial_no = unescape($item.attr('data-serial-no'));\n\t\t\tlet uom = unescape($item.attr('data-uom'));\n\t\t\tlet rate = unescape($item.attr('data-rate'));\n\n\t\t\t// escape(undefined) returns \"undefined\" then unescape returns \"undefined\"\n\t\t\tbatch_no = batch_no === \"undefined\" ? undefined : batch_no;\n\t\t\tserial_no = serial_no === \"undefined\" ? undefined : serial_no;\n\t\t\tuom = uom === \"undefined\" ? undefined : uom;\n\t\t\trate = rate === \"undefined\" ? undefined : rate;\n\n\t\t\tme.events.item_selected({\n\t\t\t\tfield: 'qty',\n\t\t\t\tvalue: \"+1\",\n\t\t\t\titem: { item_code, batch_no, serial_no, uom, rate }\n\t\t\t});\n\t\t\tme.search_field.set_focus();\n\t\t});\n\n\t\tthis.search_field.$input.on('input', (e) => {\n\t\t\tclearTimeout(this.last_search);\n\t\t\tthis.last_search = setTimeout(() => {\n\t\t\t\tconst search_term = e.target.value;\n\t\t\t\tthis.filter_items({ search_term });\n\t\t\t}, 300);\n\n\t\t\tthis.$clear_search_btn.toggle(\n\t\t\t\tBoolean(this.search_field.$input.val())\n\t\t\t);\n\t\t});\n\n\t\tthis.search_field.$input.on('focus', () => {\n\t\t\tthis.$clear_search_btn.toggle(\n\t\t\t\tBoolean(this.search_field.$input.val())\n\t\t\t);\n\t\t});\n\t}\n\n\tattach_shortcuts() {\n\t\tconst ctrl_label = frappe.utils.is_mac() ? '⌘' : 'Ctrl';\n\t\tthis.search_field.parent.attr(\"title\", `${ctrl_label}+I`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+i\",\n\t\t\taction: () => this.search_field.set_focus(),\n\t\t\tcondition: () => this.$component.is(':visible'),\n\t\t\tdescription: __(\"Focus on search input\"),\n\t\t\tignore_inputs: true,\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t\tthis.item_group_field.parent.attr(\"title\", `${ctrl_label}+G`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+g\",\n\t\t\taction: () => this.item_group_field.set_focus(),\n\t\t\tcondition: () => this.$component.is(':visible'),\n\t\t\tdescription: __(\"Focus on Item Group filter\"),\n\t\t\tignore_inputs: true,\n\t\t\tpage: cur_page.page.page\n\t\t});\n\n\t\t// for selecting the last filtered item on search\n\t\tfrappe.ui.keys.on(\"enter\", () => {\n\t\t\tconst selector_is_visible = this.$component.is(':visible');\n\t\t\tif (!selector_is_visible || this.search_field.get_value() === \"\") return;\n\n\t\t\tif (this.items.length == 1) {\n\t\t\t\tthis.$items_container.find(\".item-wrapper\").click();\n\t\t\t\tfrappe.utils.play_sound(\"submit\");\n\t\t\t\tthis.set_search_value('');\n\t\t\t} else if (this.items.length == 0 && this.barcode_scanned) {\n\t\t\t\t// only show alert of barcode is scanned and enter is pressed\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tmessage: __(\"No items found. Scan barcode again.\"),\n\t\t\t\t\tindicator: 'orange'\n\t\t\t\t});\n\t\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\t\tthis.barcode_scanned = false;\n\t\t\t\tthis.set_search_value('');\n\t\t\t}\n\t\t});\n\t}\n\n\tfilter_items({ search_term='' }={}) {\n\t\tif (search_term) {\n\t\t\tsearch_term = search_term.toLowerCase();\n\n\t\t\t// memoize\n\t\t\tthis.search_index = this.search_index || {};\n\t\t\tif (this.search_index[search_term]) {\n\t\t\t\tconst items = this.search_index[search_term];\n\t\t\t\tthis.items = items;\n\t\t\t\tthis.render_item_list(items);\n\t\t\t\tthis.auto_add_item && this.items.length == 1 && this.add_filtered_item_to_cart();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis.get_items({ search_term })\n\t\t\t.then(({ message }) => {\n\t\t\t\t// eslint-disable-next-line no-unused-vars\n\t\t\t\tconst { items, serial_no, batch_no, barcode } = message;\n\t\t\t\tif (search_term && !barcode) {\n\t\t\t\t\tthis.search_index[search_term] = items;\n\t\t\t\t}\n\t\t\t\tthis.items = items;\n\t\t\t\tthis.render_item_list(items);\n\t\t\t\tthis.auto_add_item && this.items.length == 1 && this.add_filtered_item_to_cart();\n\t\t\t});\n\t}\n\n\tadd_filtered_item_to_cart() {\n\t\tthis.$items_container.find(\".item-wrapper\").click();\n\t\tthis.set_search_value('');\n\t}\n\n\tresize_selector(minimize) {\n\t\tminimize ?\n\t\t\tthis.$component.find('.filter-section').css('grid-template-columns', 'repeat(1, minmax(0, 1fr))') :\n\t\t\tthis.$component.find('.filter-section').css('grid-template-columns', 'repeat(12, minmax(0, 1fr))');\n\n\t\tminimize ?\n\t\t\tthis.$component.find('.search-field').css('margin', 'var(--margin-sm) 0px') :\n\t\t\tthis.$component.find('.search-field').css('margin', '0px var(--margin-sm)');\n\n\t\tminimize ?\n\t\t\tthis.$component.css('grid-column', 'span 2 / span 2') :\n\t\t\tthis.$component.css('grid-column', 'span 6 / span 6');\n\n\t\tminimize ?\n\t\t\tthis.$items_container.css('grid-template-columns', 'repeat(1, minmax(0, 1fr))') :\n\t\t\tthis.$items_container.css('grid-template-columns', 'repeat(4, minmax(0, 1fr))');\n\t}\n\n\ttoggle_component(show) {\n\t\tthis.set_search_value('');\n\t\tthis.$component.css('display', show ? 'flex': 'none');\n\t}\n};\n","erpnext.PointOfSale.ItemCart = class {\n\tconstructor({ wrapper, events, settings }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\t\tthis.customer_info = undefined;\n\t\tthis.hide_images = settings.hide_images;\n\t\tthis.allowed_customer_groups = settings.customer_groups;\n\t\tthis.allow_rate_change = settings.allow_rate_change;\n\t\tthis.allow_discount_change = settings.allow_discount_change;\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.init_child_components();\n\t\tthis.bind_events();\n\t\tthis.attach_shortcuts();\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"customer-cart-container\"></section>`\n\t\t)\n\n\t\tthis.$component = this.wrapper.find('.customer-cart-container');\n\t}\n\n\tinit_child_components() {\n\t\tthis.init_customer_selector();\n\t\tthis.init_cart_components();\n\t}\n\n\tinit_customer_selector() {\n\t\tthis.$component.append(\n\t\t\t`<div class=\"customer-section\"></div>`\n\t\t)\n\t\tthis.$customer_section = this.$component.find('.customer-section');\n\t\tthis.make_customer_selector();\n\t}\n\n\treset_customer_selector() {\n\t\tconst frm = this.events.get_frm();\n\t\tfrm.set_value('customer', '');\n\t\tthis.make_customer_selector();\n\t\tthis.customer_field.set_focus();\n\t}\n\n\tinit_cart_components() {\n\t\tthis.$component.append(\n\t\t\t`<div class=\"cart-container\">\n\t\t\t\t<div class=\"abs-cart-container\">\n\t\t\t\t\t<div class=\"cart-label\">${__('Item Cart')}</div>\n\t\t\t\t\t<div class=\"cart-header\">\n\t\t\t\t\t\t<div class=\"name-header\">${__('Item')}</div>\n\t\t\t\t\t\t<div class=\"qty-header\">${__('Quantity')}</div>\n\t\t\t\t\t\t<div class=\"rate-amount-header\">${__('Amount')}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"cart-items-section\"></div>\n\t\t\t\t\t<div class=\"cart-totals-section\"></div>\n\t\t\t\t\t<div class=\"numpad-section\"></div>\n\t\t\t\t</div>\n\t\t\t</div>`\n\t\t);\n\t\tthis.$cart_container = this.$component.find('.cart-container');\n\n\t\tthis.make_cart_totals_section();\n\t\tthis.make_cart_items_section();\n\t\tthis.make_cart_numpad();\n\t}\n\n\tmake_cart_items_section() {\n\t\tthis.$cart_header = this.$component.find('.cart-header');\n\t\tthis.$cart_items_wrapper = this.$component.find('.cart-items-section');\n\n\t\tthis.make_no_items_placeholder();\n\t}\n\n\tmake_no_items_placeholder() {\n\t\tthis.$cart_header.css('display', 'none');\n\t\tthis.$cart_items_wrapper.html(\n\t\t\t`<div class=\"no-item-wrapper\">${__('No items in cart')}</div>`\n\t\t);\n\t}\n\n\tget_discount_icon() {\n\t\treturn (\n\t\t\t`<svg class=\"discount-icon\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n\t\t\t\t<path d=\"M19 15.6213C19 15.2235 19.158 14.842 19.4393 14.5607L20.9393 13.0607C21.5251 12.4749 21.5251 11.5251 20.9393 10.9393L19.4393 9.43934C19.158 9.15804 19 8.7765 19 8.37868V6.5C19 5.67157 18.3284 5 17.5 5H15.6213C15.2235 5 14.842 4.84196 14.5607 4.56066L13.0607 3.06066C12.4749 2.47487 11.5251 2.47487 10.9393 3.06066L9.43934 4.56066C9.15804 4.84196 8.7765 5 8.37868 5H6.5C5.67157 5 5 5.67157 5 6.5V8.37868C5 8.7765 4.84196 9.15804 4.56066 9.43934L3.06066 10.9393C2.47487 11.5251 2.47487 12.4749 3.06066 13.0607L4.56066 14.5607C4.84196 14.842 5 15.2235 5 15.6213V17.5C5 18.3284 5.67157 19 6.5 19H8.37868C8.7765 19 9.15804 19.158 9.43934 19.4393L10.9393 20.9393C11.5251 21.5251 12.4749 21.5251 13.0607 20.9393L14.5607 19.4393C14.842 19.158 15.2235 19 15.6213 19H17.5C18.3284 19 19 18.3284 19 17.5V15.6213Z\" stroke-miterlimit=\"10\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n\t\t\t\t<path d=\"M15 9L9 15\" stroke-miterlimit=\"10\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n\t\t\t\t<path d=\"M10.5 9.5C10.5 10.0523 10.0523 10.5 9.5 10.5C8.94772 10.5 8.5 10.0523 8.5 9.5C8.5 8.94772 8.94772 8.5 9.5 8.5C10.0523 8.5 10.5 8.94772 10.5 9.5Z\" fill=\"white\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n\t\t\t\t<path d=\"M15.5 14.5C15.5 15.0523 15.0523 15.5 14.5 15.5C13.9477 15.5 13.5 15.0523 13.5 14.5C13.5 13.9477 13.9477 13.5 14.5 13.5C15.0523 13.5 15.5 13.9477 15.5 14.5Z\" fill=\"white\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n\t\t\t</svg>`\n\t\t);\n\t}\n\n\tmake_cart_totals_section() {\n\t\tthis.$totals_section = this.$component.find('.cart-totals-section');\n\n\t\tthis.$totals_section.append(\n\t\t\t`<div class=\"add-discount-wrapper\">\n\t\t\t\t${this.get_discount_icon()} ${__('Add Discount')}\n\t\t\t</div>\n\t\t\t<div class=\"item-qty-total-container\">\n\t\t\t\t<div class=\"item-qty-total-label\">${__('Total Items')}</div>\n\t\t\t\t<div class=\"item-qty-total-value\">0.00</div>\n\t\t\t</div>\n\t\t\t<div class=\"net-total-container\">\n\t\t\t\t<div class=\"net-total-label\">${__(\"Net Total\")}</div>\n\t\t\t\t<div class=\"net-total-value\">0.00</div>\n\t\t\t</div>\n\t\t\t<div class=\"taxes-container\"></div>\n\t\t\t<div class=\"grand-total-container\">\n\t\t\t\t<div>${__('Grand Total')}</div>\n\t\t\t\t<div>0.00</div>\n\t\t\t</div>\n\t\t\t<div class=\"checkout-btn\">${__('Checkout')}</div>\n\t\t\t<div class=\"edit-cart-btn\">${__('Edit Cart')}</div>`\n\t\t)\n\n\t\tthis.$add_discount_elem = this.$component.find(\".add-discount-wrapper\");\n\t}\n\n\tmake_cart_numpad() {\n\t\tthis.$numpad_section = this.$component.find('.numpad-section');\n\n\t\tthis.number_pad = new erpnext.PointOfSale.NumberPad({\n\t\t\twrapper: this.$numpad_section,\n\t\t\tevents: {\n\t\t\t\tnumpad_event: this.on_numpad_event.bind(this)\n\t\t\t},\n\t\t\tcols: 5,\n\t\t\tkeys: [\n\t\t\t\t[ 1, 2, 3, 'Quantity' ],\n\t\t\t\t[ 4, 5, 6, 'Discount' ],\n\t\t\t\t[ 7, 8, 9, 'Rate' ],\n\t\t\t\t[ '.', 0, 'Delete', 'Remove' ]\n\t\t\t],\n\t\t\tcss_classes: [\n\t\t\t\t[ '', '', '', 'col-span-2' ],\n\t\t\t\t[ '', '', '', 'col-span-2' ],\n\t\t\t\t[ '', '', '', 'col-span-2' ],\n\t\t\t\t[ '', '', '', 'col-span-2 remove-btn' ]\n\t\t\t],\n\t\t\tfieldnames_map: { 'Quantity': 'qty', 'Discount': 'discount_percentage' }\n\t\t})\n\n\t\tthis.$numpad_section.prepend(\n\t\t\t`<div class=\"numpad-totals\">\n\t\t\t<span class=\"numpad-item-qty-total\"></span>\n\t\t\t\t<span class=\"numpad-net-total\"></span>\n\t\t\t\t<span class=\"numpad-grand-total\"></span>\n\t\t\t</div>`\n\t\t)\n\n\t\tthis.$numpad_section.append(\n\t\t\t`<div class=\"numpad-btn checkout-btn\" data-button-value=\"checkout\">${__('Checkout')}</div>`\n\t\t)\n\t}\n\n\tbind_events() {\n\t\tconst me = this;\n\t\tthis.$customer_section.on('click', '.reset-customer-btn', function () {\n\t\t\tme.reset_customer_selector();\n\t\t});\n\n\t\tthis.$customer_section.on('click', '.close-details-btn', function () {\n\t\t\tme.toggle_customer_info(false);\n\t\t});\n\n\t\tthis.$customer_section.on('click', '.customer-display', function(e) {\n\t\t\tif ($(e.target).closest('.reset-customer-btn').length) return;\n\n\t\t\tconst show = me.$cart_container.is(':visible');\n\t\t\tme.toggle_customer_info(show);\n\t\t});\n\n\t\tthis.$cart_items_wrapper.on('click', '.cart-item-wrapper', function() {\n\t\t\tconst $cart_item = $(this);\n\n\t\t\tme.toggle_item_highlight(this);\n\n\t\t\tconst payment_section_hidden = !me.$totals_section.find('.edit-cart-btn').is(':visible');\n\t\t\tif (!payment_section_hidden) {\n\t\t\t\t// payment section is visible\n\t\t\t\t// edit cart first and then open item details section\n\t\t\t\tme.$totals_section.find(\".edit-cart-btn\").click();\n\t\t\t}\n\n\t\t\tconst item_row_name = unescape($cart_item.attr('data-row-name'));\n\t\t\tme.events.cart_item_clicked({ name: item_row_name });\n\t\t\tthis.numpad_value = '';\n\t\t});\n\n\t\tthis.$component.on('click', '.checkout-btn', async function() {\n\t\t\tif ($(this).attr('style').indexOf('--blue-500') == -1) return;\n\n\t\t\tawait me.events.checkout();\n\t\t\tme.toggle_checkout_btn(false);\n\n\t\t\tme.allow_discount_change && me.$add_discount_elem.removeClass(\"d-none\");\n\t\t});\n\n\t\tthis.$totals_section.on('click', '.edit-cart-btn', () => {\n\t\t\tthis.events.edit_cart();\n\t\t\tthis.toggle_checkout_btn(true);\n\t\t});\n\n\t\tthis.$component.on('click', '.add-discount-wrapper', () => {\n\t\t\tconst can_edit_discount = this.$add_discount_elem.find('.edit-discount-btn').length;\n\n\t\t\tif(!this.discount_field || can_edit_discount) this.show_discount_control();\n\t\t});\n\n\t\tfrappe.ui.form.on(\"POS Invoice\", \"paid_amount\", frm => {\n\t\t\t// called when discount is applied\n\t\t\tthis.update_totals_section(frm);\n\t\t});\n\t}\n\n\tattach_shortcuts() {\n\t\tfor (let row of this.number_pad.keys) {\n\t\t\tfor (let btn of row) {\n\t\t\t\tif (typeof btn !== 'string') continue; // do not make shortcuts for numbers\n\n\t\t\t\tlet shortcut_key = `ctrl+${frappe.scrub(String(btn))[0]}`;\n\t\t\t\tif (btn === 'Delete') shortcut_key = 'ctrl+backspace';\n\t\t\t\tif (btn === 'Remove') shortcut_key = 'shift+ctrl+backspace'\n\t\t\t\tif (btn === '.') shortcut_key = 'ctrl+>';\n\n\t\t\t\t// to account for fieldname map\n\t\t\t\tconst fieldname = this.number_pad.fieldnames[btn] ? this.number_pad.fieldnames[btn] :\n\t\t\t\t\ttypeof btn === 'string' ? frappe.scrub(btn) : btn;\n\n\t\t\t\tlet shortcut_label = shortcut_key.split('+').map(frappe.utils.to_title_case).join('+');\n\t\t\t\tshortcut_label = frappe.utils.is_mac() ? shortcut_label.replace('Ctrl', '⌘') : shortcut_label;\n\t\t\t\tthis.$numpad_section.find(`.numpad-btn[data-button-value=\"${fieldname}\"]`).attr(\"title\", shortcut_label);\n\n\t\t\t\tfrappe.ui.keys.on(`${shortcut_key}`, () => {\n\t\t\t\t\tconst cart_is_visible = this.$component.is(\":visible\");\n\t\t\t\t\tif (cart_is_visible && this.item_is_selected && this.$numpad_section.is(\":visible\")) {\n\t\t\t\t\t\tthis.$numpad_section.find(`.numpad-btn[data-button-value=\"${fieldname}\"]`).click();\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\tconst ctrl_label = frappe.utils.is_mac() ? '⌘' : 'Ctrl';\n\t\tthis.$component.find(\".checkout-btn\").attr(\"title\", `${ctrl_label}+Enter`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+enter\",\n\t\t\taction: () => this.$component.find(\".checkout-btn\").click(),\n\t\t\tcondition: () => this.$component.is(\":visible\") && !this.$totals_section.find('.edit-cart-btn').is(':visible'),\n\t\t\tdescription: __(\"Checkout Order / Submit Order / New Order\"),\n\t\t\tignore_inputs: true,\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t\tthis.$component.find(\".edit-cart-btn\").attr(\"title\", `${ctrl_label}+E`);\n\t\tfrappe.ui.keys.on(\"ctrl+e\", () => {\n\t\t\tconst item_cart_visible = this.$component.is(\":visible\");\n\t\t\tconst checkout_btn_invisible = !this.$totals_section.find('.checkout-btn').is('visible');\n\t\t\tif (item_cart_visible && checkout_btn_invisible) {\n\t\t\t\tthis.$component.find(\".edit-cart-btn\").click();\n\t\t\t}\n\t\t});\n\t\tthis.$component.find(\".add-discount-wrapper\").attr(\"title\", `${ctrl_label}+D`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+d\",\n\t\t\taction: () => this.$component.find(\".add-discount-wrapper\").click(),\n\t\t\tcondition: () => this.$add_discount_elem.is(\":visible\"),\n\t\t\tdescription: __(\"Add Order Discount\"),\n\t\t\tignore_inputs: true,\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t\tfrappe.ui.keys.on(\"escape\", () => {\n\t\t\tconst item_cart_visible = this.$component.is(\":visible\");\n\t\t\tif (item_cart_visible && this.discount_field && this.discount_field.parent.is(\":visible\")) {\n\t\t\t\tthis.discount_field.set_value(0);\n\t\t\t}\n\t\t});\n\t}\n\n\ttoggle_item_highlight(item) {\n\t\tconst $cart_item = $(item);\n\t\tconst item_is_highlighted = $cart_item.attr(\"style\") == \"background-color:var(--gray-50);\";\n\n\t\tif (!item || item_is_highlighted) {\n\t\t\tthis.item_is_selected = false;\n\t\t\tthis.$cart_container.find('.cart-item-wrapper').css(\"background-color\", \"\");\n\t\t} else {\n\t\t\t$cart_item.css(\"background-color\", \"var(--gray-50)\");\n\t\t\tthis.item_is_selected = true;\n\t\t\tthis.$cart_container.find('.cart-item-wrapper').not(item).css(\"background-color\", \"\");\n\t\t}\n\t}\n\n\tmake_customer_selector() {\n\t\tthis.$customer_section.html(`\n\t\t\t<div class=\"customer-field\"></div>\n\t\t`);\n\t\tconst me = this;\n\t\tconst query = { query: 'erpnext.controllers.queries.customer_query' };\n\t\tconst allowed_customer_group = this.allowed_customer_groups || [];\n\t\tif (allowed_customer_group.length) {\n\t\t\tquery.filters = {\n\t\t\t\tcustomer_group: ['in', allowed_customer_group]\n\t\t\t}\n\t\t}\n\t\tthis.customer_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Customer'),\n\t\t\t\tfieldtype: 'Link',\n\t\t\t\toptions: 'Customer',\n\t\t\t\tplaceholder: __('Search by customer name, phone, email.'),\n\t\t\t\tget_query: () => query,\n\t\t\t\tonchange: function() {\n\t\t\t\t\tif (this.value) {\n\t\t\t\t\t\tconst frm = me.events.get_frm();\n\t\t\t\t\t\tfrappe.dom.freeze();\n\t\t\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'customer', this.value);\n\t\t\t\t\t\tfrm.script_manager.trigger('customer', frm.doc.doctype, frm.doc.name).then(() => {\n\t\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t\t() => me.fetch_customer_details(this.value),\n\t\t\t\t\t\t\t\t() => me.events.customer_details_updated(me.customer_info),\n\t\t\t\t\t\t\t\t() => me.update_customer_section(),\n\t\t\t\t\t\t\t\t() => me.update_totals_section(),\n\t\t\t\t\t\t\t\t() => frappe.dom.unfreeze()\n\t\t\t\t\t\t\t]);\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\tparent: this.$customer_section.find('.customer-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.customer_field.toggle_label(false);\n\t}\n\n\tfetch_customer_details(customer) {\n\t\tif (customer) {\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tfrappe.db.get_value('Customer', customer, [\"email_id\", \"mobile_no\", \"image\", \"loyalty_program\"]).then(({ message }) => {\n\t\t\t\t\tconst { loyalty_program } = message;\n\t\t\t\t\t// if loyalty program then fetch loyalty points too\n\t\t\t\t\tif (loyalty_program) {\n\t\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\t\tmethod: \"erpnext.accounts.doctype.loyalty_program.loyalty_program.get_loyalty_program_details_with_points\",\n\t\t\t\t\t\t\targs: { customer, loyalty_program, \"silent\": true },\n\t\t\t\t\t\t\tcallback: (r) => {\n\t\t\t\t\t\t\t\tconst { loyalty_points, conversion_factor } = r.message;\n\t\t\t\t\t\t\t\tif (!r.exc) {\n\t\t\t\t\t\t\t\t\tthis.customer_info = { ...message, customer, loyalty_points, conversion_factor };\n\t\t\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.customer_info = { ...message, customer };\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t} else {\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tthis.customer_info = {}\n\t\t\t\tresolve();\n\t\t\t});\n\t\t}\n\t}\n\n\tshow_discount_control() {\n\t\tthis.$add_discount_elem.css({ 'padding': '0px', 'border': 'none' });\n\t\tthis.$add_discount_elem.html(\n\t\t\t`<div class=\"add-discount-field\"></div>`\n\t\t);\n\t\tconst me = this;\n\t\tconst frm = me.events.get_frm();\n\t\tlet discount = frm.doc.additional_discount_percentage;\n\n\t\tthis.discount_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Discount'),\n\t\t\t\tfieldtype: 'Data',\n\t\t\t\tplaceholder: ( discount ? discount + '%' :  __('Enter discount percentage.') ),\n\t\t\t\tinput_class: 'input-xs',\n\t\t\t\tonchange: function() {\n\t\t\t\t\tif (flt(this.value) != 0) {\n\t\t\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'additional_discount_percentage', flt(this.value));\n\t\t\t\t\t\tme.hide_discount_control(this.value);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfrappe.model.set_value(frm.doc.doctype, frm.doc.name, 'additional_discount_percentage', 0);\n\t\t\t\t\t\tme.$add_discount_elem.css({\n\t\t\t\t\t\t\t'border': '1px dashed var(--gray-500)',\n\t\t\t\t\t\t\t'padding': 'var(--padding-sm) var(--padding-md)'\n\t\t\t\t\t\t});\n\t\t\t\t\t\tme.$add_discount_elem.html(`${me.get_discount_icon()} ${__('Add Discount')}`);\n\t\t\t\t\t\tme.discount_field = undefined;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\tparent: this.$add_discount_elem.find('.add-discount-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.discount_field.toggle_label(false);\n\t\tthis.discount_field.set_focus();\n\t}\n\n\thide_discount_control(discount) {\n\t\tif (!discount) {\n\t\t\tthis.$add_discount_elem.css({ 'padding': '0px', 'border': 'none' });\n\t\t\tthis.$add_discount_elem.html(\n\t\t\t\t`<div class=\"add-discount-field\"></div>`\n\t\t\t);\n\t\t} else {\n\t\t\tthis.$add_discount_elem.css({\n\t\t\t\t'border': '1px dashed var(--dark-green-500)',\n\t\t\t\t'padding': 'var(--padding-sm) var(--padding-md)'\n\t\t\t});\n\t\t\tthis.$add_discount_elem.html(\n\t\t\t\t`<div class=\"edit-discount-btn\">\n\t\t\t\t\t${this.get_discount_icon()} ${__(\"Additional\")}&nbsp;${String(discount).bold()}% ${__(\"discount applied\")}\n\t\t\t\t</div>`\n\t\t\t);\n\t\t}\n\t}\n\n\tupdate_customer_section() {\n\t\tconst me = this;\n\t\tconst { customer, email_id='', mobile_no='', image } = this.customer_info || {};\n\n\t\tif (customer) {\n\t\t\tthis.$customer_section.html(\n\t\t\t\t`<div class=\"customer-details\">\n\t\t\t\t\t<div class=\"customer-display\">\n\t\t\t\t\t\t${this.get_customer_image()}\n\t\t\t\t\t\t<div class=\"customer-name-desc\">\n\t\t\t\t\t\t\t<div class=\"customer-name\">${customer}</div>\n\t\t\t\t\t\t\t${get_customer_description()}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"reset-customer-btn\" data-customer=\"${escape(customer)}\">\n\t\t\t\t\t\t\t<svg width=\"32\" height=\"32\" viewBox=\"0 0 14 14\" fill=\"none\">\n\t\t\t\t\t\t\t\t<path d=\"M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759\" stroke=\"#8D99A6\"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>`\n\t\t\t);\n\t\t} else {\n\t\t\t// reset customer selector\n\t\t\tthis.reset_customer_selector();\n\t\t}\n\n\t\tfunction get_customer_description() {\n\t\t\tif (!email_id && !mobile_no) {\n\t\t\t\treturn `<div class=\"customer-desc\">${__('Click to add email / phone')}</div>`;\n\t\t\t} else if (email_id && !mobile_no) {\n\t\t\t\treturn `<div class=\"customer-desc\">${email_id}</div>`;\n\t\t\t} else if (mobile_no && !email_id) {\n\t\t\t\treturn `<div class=\"customer-desc\">${mobile_no}</div>`;\n\t\t\t} else {\n\t\t\t\treturn `<div class=\"customer-desc\">${email_id} - ${mobile_no}</div>`;\n\t\t\t}\n\t\t}\n\n\t}\n\n\tget_customer_image() {\n\t\tconst { customer, image } = this.customer_info || {};\n\t\tif (image) {\n\t\t\treturn `<div class=\"customer-image\"><img src=\"${image}\" alt=\"${image}\"\"></div>`;\n\t\t} else {\n\t\t\treturn `<div class=\"customer-image customer-abbr\">${frappe.get_abbr(customer)}</div>`;\n\t\t}\n\t}\n\n\tupdate_totals_section(frm) {\n\t\tif (!frm) frm = this.events.get_frm();\n\n\t\tthis.render_net_total(frm.doc.net_total);\n\t\tthis.render_total_item_qty(frm.doc.items);\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? frm.doc.grand_total : frm.doc.rounded_total;\n\t\tthis.render_grand_total(grand_total);\n\n\t\tthis.render_taxes(frm.doc.taxes);\n\t}\n\n\trender_net_total(value) {\n\t\tconst currency = this.events.get_frm().doc.currency;\n\t\tthis.$totals_section.find('.net-total-container').html(\n\t\t\t`<div>${__('Net Total')}</div><div>${format_currency(value, currency)}</div>`\n\t\t)\n\n\t\tthis.$numpad_section.find('.numpad-net-total').html(\n\t\t\t`<div>${__('Net Total')}: <span>${format_currency(value, currency)}</span></div>`\n\t\t);\n\t}\n\n\trender_total_item_qty(items) {\n\t\tvar total_item_qty = 0;\n\t\titems.map((item) => {\n\t\t\ttotal_item_qty = total_item_qty + item.qty;\n\t\t});\n\n\t\tthis.$totals_section.find('.item-qty-total-container').html(\n\t\t\t`<div>${__('Total Quantity')}</div><div>${total_item_qty}</div>`\n\t\t);\n\n\t\tthis.$numpad_section.find('.numpad-item-qty-total').html(\n\t\t\t`<div>${__('Total Quantity')}: <span>${total_item_qty}</span></div>`\n\t\t);\n\t}\n\n\trender_grand_total(value) {\n\t\tconst currency = this.events.get_frm().doc.currency;\n\t\tthis.$totals_section.find('.grand-total-container').html(\n\t\t\t`<div>${__('Grand Total')}</div><div>${format_currency(value, currency)}</div>`\n\t\t)\n\n\t\tthis.$numpad_section.find('.numpad-grand-total').html(\n\t\t\t`<div>${__('Grand Total')}: <span>${format_currency(value, currency)}</span></div>`\n\t\t);\n\t}\n\n\trender_taxes(taxes) {\n\t\tif (taxes.length) {\n\t\t\tconst currency = this.events.get_frm().doc.currency;\n\t\t\tconst taxes_html = taxes.map(t => {\n\t\t\t\tif (t.tax_amount_after_discount_amount == 0.0) return;\n\t\t\t\tconst description = /[0-9]+/.test(t.description) ? t.description : `${t.description} @ ${t.rate}%`;\n\t\t\t\treturn `<div class=\"tax-row\">\n\t\t\t\t\t<div class=\"tax-label\">${description}</div>\n\t\t\t\t\t<div class=\"tax-value\">${format_currency(t.tax_amount_after_discount_amount, currency)}</div>\n\t\t\t\t</div>`;\n\t\t\t}).join('');\n\t\t\tthis.$totals_section.find('.taxes-container').css('display', 'flex').html(taxes_html);\n\t\t} else {\n\t\t\tthis.$totals_section.find('.taxes-container').css('display', 'none').html('');\n\t\t}\n\t}\n\n\tget_cart_item({ name }) {\n\t\tconst item_selector = `.cart-item-wrapper[data-row-name=\"${escape(name)}\"]`;\n\t\treturn this.$cart_items_wrapper.find(item_selector);\n\t}\n\n\tget_item_from_frm(item) {\n\t\tconst doc = this.events.get_frm().doc;\n\t\treturn doc.items.find(i => i.name == item.name);\n\t}\n\n\tupdate_item_html(item, remove_item) {\n\t\tconst $item = this.get_cart_item(item);\n\n\t\tif (remove_item) {\n\t\t\t$item && $item.next().remove() && $item.remove();\n\t\t} else {\n\t\t\tconst item_row = this.get_item_from_frm(item);\n\t\t\tthis.render_cart_item(item_row, $item);\n\t\t}\n\n\t\tconst no_of_cart_items = this.$cart_items_wrapper.find('.cart-item-wrapper').length;\n\t\tthis.highlight_checkout_btn(no_of_cart_items > 0);\n\n\t\tthis.update_empty_cart_section(no_of_cart_items);\n\t}\n\n\trender_cart_item(item_data, $item_to_update) {\n\t\tconst currency = this.events.get_frm().doc.currency;\n\t\tconst me = this;\n\n\t\tif (!$item_to_update.length) {\n\t\t\tthis.$cart_items_wrapper.append(\n\t\t\t\t`<div class=\"cart-item-wrapper\" data-row-name=\"${escape(item_data.name)}\"></div>\n\t\t\t\t<div class=\"seperator\"></div>`\n\t\t\t)\n\t\t\t$item_to_update = this.get_cart_item(item_data);\n\t\t}\n\n\t\t$item_to_update.html(\n\t\t\t`${get_item_image_html()}\n\t\t\t<div class=\"item-name-desc\">\n\t\t\t\t<div class=\"item-name\">\n\t\t\t\t\t${item_data.item_name}\n\t\t\t\t</div>\n\t\t\t\t${get_description_html()}\n\t\t\t</div>\n\t\t\t${get_rate_discount_html()}`\n\t\t)\n\n\t\tset_dynamic_rate_header_width();\n\n\t\tfunction set_dynamic_rate_header_width() {\n\t\t\tconst rate_cols = Array.from(me.$cart_items_wrapper.find(\".item-rate-amount\"));\n\t\t\tme.$cart_header.find(\".rate-amount-header\").css(\"width\", \"\");\n\t\t\tme.$cart_items_wrapper.find(\".item-rate-amount\").css(\"width\", \"\");\n\t\t\tlet max_width = rate_cols.reduce((max_width, elm) => {\n\t\t\t\tif ($(elm).width() > max_width)\n\t\t\t\t\tmax_width = $(elm).width();\n\t\t\t\treturn max_width;\n\t\t\t}, 0);\n\n\t\t\tmax_width += 1;\n\t\t\tif (max_width == 1) max_width = \"\";\n\n\t\t\tme.$cart_header.find(\".rate-amount-header\").css(\"width\", max_width);\n\t\t\tme.$cart_items_wrapper.find(\".item-rate-amount\").css(\"width\", max_width);\n\t\t}\n\n\t\tfunction get_rate_discount_html() {\n\t\t\tif (item_data.rate && item_data.amount && item_data.rate !== item_data.amount) {\n\t\t\t\treturn `\n\t\t\t\t\t<div class=\"item-qty-rate\">\n\t\t\t\t\t\t<div class=\"item-qty\"><span>${item_data.qty || 0}</span></div>\n\t\t\t\t\t\t<div class=\"item-rate-amount\">\n\t\t\t\t\t\t\t<div class=\"item-rate\">${format_currency(item_data.amount, currency)}</div>\n\t\t\t\t\t\t\t<div class=\"item-amount\">${format_currency(item_data.rate, currency)}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>`\n\t\t\t} else {\n\t\t\t\treturn `\n\t\t\t\t\t<div class=\"item-qty-rate\">\n\t\t\t\t\t\t<div class=\"item-qty\"><span>${item_data.qty || 0}</span></div>\n\t\t\t\t\t\t<div class=\"item-rate-amount\">\n\t\t\t\t\t\t\t<div class=\"item-rate\">${format_currency(item_data.rate, currency)}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>`\n\t\t\t}\n\t\t}\n\n\t\tfunction get_description_html() {\n\t\t\tif (item_data.description) {\n\t\t\t\tif (item_data.description.indexOf('<div>') != -1) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\titem_data.description = $(item_data.description).text();\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\titem_data.description = item_data.description.replace(/<div>/g, ' ').replace(/<\\/div>/g, ' ').replace(/ +/g, ' ');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\titem_data.description = frappe.ellipsis(item_data.description, 45);\n\t\t\t\treturn `<div class=\"item-desc\">${item_data.description}</div>`;\n\t\t\t}\n\t\t\treturn ``;\n\t\t}\n\n\t\tfunction get_item_image_html() {\n\t\t\tconst { image, item_name } = item_data;\n\t\t\tif (!me.hide_images && image) {\n\t\t\t\treturn `\n\t\t\t\t\t<div class=\"item-image\">\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tonerror=\"cur_pos.cart.handle_broken_image(this)\"\n\t\t\t\t\t\t\tsrc=\"${image}\" alt=\"${frappe.get_abbr(item_name)}\"\">\n\t\t\t\t\t</div>`;\n\t\t\t} else {\n\t\t\t\treturn `<div class=\"item-image item-abbr\">${frappe.get_abbr(item_name)}</div>`;\n\t\t\t}\n\t\t}\n\t}\n\n\thandle_broken_image($img) {\n\t\tconst item_abbr = $($img).attr('alt');\n\t\t$($img).parent().replaceWith(`<div class=\"item-image item-abbr\">${item_abbr}</div>`);\n\t}\n\n\tupdate_selector_value_in_cart_item(selector, value, item) {\n\t\tconst $item_to_update = this.get_cart_item(item);\n\t\t$item_to_update.attr(`data-${selector}`, escape(value));\n\t}\n\n\ttoggle_checkout_btn(show_checkout) {\n\t\tif (show_checkout) {\n\t\t\tthis.$totals_section.find('.checkout-btn').css('display', 'flex');\n\t\t\tthis.$totals_section.find('.edit-cart-btn').css('display', 'none');\n\t\t} else {\n\t\t\tthis.$totals_section.find('.checkout-btn').css('display', 'none');\n\t\t\tthis.$totals_section.find('.edit-cart-btn').css('display', 'flex');\n\t\t}\n\t}\n\n\thighlight_checkout_btn(toggle) {\n\t\tif (toggle) {\n\t\t\tthis.$add_discount_elem.css('display', 'flex');\n\t\t\tthis.$cart_container.find('.checkout-btn').css({\n\t\t\t\t'background-color': 'var(--blue-500)'\n\t\t\t});\n\t\t} else {\n\t\t\tthis.$add_discount_elem.css('display', 'none');\n\t\t\tthis.$cart_container.find('.checkout-btn').css({\n\t\t\t\t'background-color': 'var(--blue-200)'\n\t\t\t});\n\t\t}\n\t}\n\n\tupdate_empty_cart_section(no_of_cart_items) {\n\t\tconst $no_item_element = this.$cart_items_wrapper.find('.no-item-wrapper');\n\n\t\t// if cart has items and no item is present\n\t\tno_of_cart_items > 0 && $no_item_element && $no_item_element.remove() && this.$cart_header.css('display', 'flex');\n\n\t\tno_of_cart_items === 0 && !$no_item_element.length && this.make_no_items_placeholder();\n\t}\n\n\ton_numpad_event($btn) {\n\t\tconst current_action = $btn.attr('data-button-value');\n\t\tconst action_is_field_edit = ['qty', 'discount_percentage', 'rate'].includes(current_action);\n\t\tconst action_is_allowed = action_is_field_edit ? (\n\t\t\t(current_action == 'rate' && this.allow_rate_change) ||\n\t\t\t(current_action == 'discount_percentage' && this.allow_discount_change) ||\n\t\t\t(current_action == 'qty')) : true;\n\n\t\tconst action_is_pressed_twice = this.prev_action === current_action;\n\t\tconst first_click_event = !this.prev_action;\n\t\tconst field_to_edit_changed = this.prev_action && this.prev_action != current_action;\n\n\t\tif (action_is_field_edit) {\n\t\t\tif (!action_is_allowed) {\n\t\t\t\tconst label = current_action == 'rate' ? 'Rate'.bold() : 'Discount'.bold();\n\t\t\t\tconst message = __('Editing {0} is not allowed as per POS Profile settings', [label]);\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tindicator: 'red',\n\t\t\t\t\tmessage: message\n\t\t\t\t});\n\t\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (first_click_event || field_to_edit_changed) {\n\t\t\t\tthis.prev_action = current_action;\n\t\t\t} else if (action_is_pressed_twice) {\n\t\t\t\tthis.prev_action = undefined;\n\t\t\t}\n\t\t\tthis.numpad_value = '';\n\n\t\t} else if (current_action === 'checkout') {\n\t\t\tthis.prev_action = undefined;\n\t\t\tthis.toggle_item_highlight();\n\t\t\tthis.events.numpad_event(undefined, current_action);\n\t\t\treturn;\n\t\t} else if (current_action === 'remove') {\n\t\t\tthis.prev_action = undefined;\n\t\t\tthis.toggle_item_highlight();\n\t\t\tthis.events.numpad_event(undefined, current_action);\n\t\t\treturn;\n\t\t} else {\n\t\t\tthis.numpad_value = current_action === 'delete' ? this.numpad_value.slice(0, -1) : this.numpad_value + current_action;\n\t\t\tthis.numpad_value = this.numpad_value || 0;\n\t\t}\n\n\t\tconst first_click_event_is_not_field_edit = !action_is_field_edit && first_click_event;\n\n\t\tif (first_click_event_is_not_field_edit) {\n\t\t\tfrappe.show_alert({\n\t\t\t\tindicator: 'red',\n\t\t\t\tmessage: __('Please select a field to edit from numpad')\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\treturn;\n\t\t}\n\n\t\tif (flt(this.numpad_value) > 100 && this.prev_action === 'discount_percentage') {\n\t\t\tfrappe.show_alert({\n\t\t\t\tmessage: __('Discount cannot be greater than 100%'),\n\t\t\t\tindicator: 'orange'\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\tthis.numpad_value = current_action;\n\t\t}\n\n\t\tthis.highlight_numpad_btn($btn, current_action);\n\t\tthis.events.numpad_event(this.numpad_value, this.prev_action);\n\t}\n\n\thighlight_numpad_btn($btn, curr_action) {\n\t\tconst curr_action_is_highlighted = $btn.hasClass('highlighted-numpad-btn');\n\t\tconst curr_action_is_action = ['qty', 'discount_percentage', 'rate', 'done'].includes(curr_action);\n\n\t\tif (!curr_action_is_highlighted) {\n\t\t\t$btn.addClass('highlighted-numpad-btn');\n\t\t}\n\t\tif (this.prev_action === curr_action && curr_action_is_highlighted) {\n\t\t\t// if Qty is pressed twice\n\t\t\t$btn.removeClass('highlighted-numpad-btn');\n\t\t}\n\t\tif (this.prev_action && this.prev_action !== curr_action && curr_action_is_action) {\n\t\t\t// Order: Qty -> Rate then remove Qty highlight\n\t\t\tconst prev_btn = $(`[data-button-value='${this.prev_action}']`);\n\t\t\tprev_btn.removeClass('highlighted-numpad-btn');\n\t\t}\n\t\tif (!curr_action_is_action || curr_action === 'done') {\n\t\t\t// if numbers are clicked\n\t\t\tsetTimeout(() => {\n\t\t\t\t$btn.removeClass('highlighted-numpad-btn');\n\t\t\t}, 200);\n\t\t}\n\t}\n\n\ttoggle_numpad(show) {\n\t\tif (show) {\n\t\t\tthis.$totals_section.css('display', 'none');\n\t\t\tthis.$numpad_section.css('display', 'flex');\n\t\t} else {\n\t\t\tthis.$totals_section.css('display', 'flex');\n\t\t\tthis.$numpad_section.css('display', 'none');\n\t\t}\n\t\tthis.reset_numpad();\n\t}\n\n\treset_numpad() {\n\t\tthis.numpad_value = '';\n\t\tthis.prev_action = undefined;\n\t\tthis.$numpad_section.find('.highlighted-numpad-btn').removeClass('highlighted-numpad-btn');\n\t}\n\n\ttoggle_numpad_field_edit(fieldname) {\n\t\tif (['qty', 'discount_percentage', 'rate'].includes(fieldname)) {\n\t\t\tthis.$numpad_section.find(`[data-button-value=\"${fieldname}\"]`).click();\n\t\t}\n\t}\n\n\ttoggle_customer_info(show) {\n\t\tif (show) {\n\t\t\tconst { customer } = this.customer_info || {};\n\n\t\t\tthis.$cart_container.css('display', 'none');\n\t\t\tthis.$customer_section.css({\n\t\t\t\t'height': '100%',\n\t\t\t\t'padding-top': '0px'\n\t\t\t});\n\t\t\tthis.$customer_section.find('.customer-details').html(\n\t\t\t\t`<div class=\"header\">\n\t\t\t\t\t<div class=\"label\">Contact Details</div>\n\t\t\t\t\t<div class=\"close-details-btn\">\n\t\t\t\t\t\t<svg width=\"32\" height=\"32\" viewBox=\"0 0 14 14\" fill=\"none\">\n\t\t\t\t\t\t\t<path d=\"M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759\" stroke=\"#8D99A6\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"customer-display\">\n\t\t\t\t\t${this.get_customer_image()}\n\t\t\t\t\t<div class=\"customer-name-desc\">\n\t\t\t\t\t\t<div class=\"customer-name\">${customer}</div>\n\t\t\t\t\t\t<div class=\"customer-desc\"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"customer-fields-container\">\n\t\t\t\t\t<div class=\"email_id-field\"></div>\n\t\t\t\t\t<div class=\"mobile_no-field\"></div>\n\t\t\t\t\t<div class=\"loyalty_program-field\"></div>\n\t\t\t\t\t<div class=\"loyalty_points-field\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"transactions-label\">Recent Transactions</div>`\n\t\t\t);\n\t\t\t// transactions need to be in diff div from sticky elem for scrolling\n\t\t\tthis.$customer_section.append(`<div class=\"customer-transactions\"></div>`);\n\n\t\t\tthis.render_customer_fields();\n\t\t\tthis.fetch_customer_transactions();\n\n\t\t} else {\n\t\t\tthis.$cart_container.css('display', 'flex');\n\t\t\tthis.$customer_section.css({\n\t\t\t\t'height': '',\n\t\t\t\t'padding-top': ''\n\t\t\t});\n\n\t\t\tthis.update_customer_section();\n\t\t}\n\t}\n\n\trender_customer_fields() {\n\t\tconst $customer_form = this.$customer_section.find('.customer-fields-container');\n\n\t\tconst dfs = [{\n\t\t\tfieldname: 'email_id',\n\t\t\tlabel: __('Email'),\n\t\t\tfieldtype: 'Data',\n\t\t\toptions: 'email',\n\t\t\tplaceholder: __(\"Enter customer's email\")\n\t\t},{\n\t\t\tfieldname: 'mobile_no',\n\t\t\tlabel: __('Phone Number'),\n\t\t\tfieldtype: 'Data',\n\t\t\tplaceholder: __(\"Enter customer's phone number\")\n\t\t},{\n\t\t\tfieldname: 'loyalty_program',\n\t\t\tlabel: __('Loyalty Program'),\n\t\t\tfieldtype: 'Link',\n\t\t\toptions: 'Loyalty Program',\n\t\t\tplaceholder: __(\"Select Loyalty Program\")\n\t\t},{\n\t\t\tfieldname: 'loyalty_points',\n\t\t\tlabel: __('Loyalty Points'),\n\t\t\tfieldtype: 'Data',\n\t\t\tread_only: 1\n\t\t}];\n\n\t\tconst me = this;\n\t\tdfs.forEach(df => {\n\t\t\tthis[`customer_${df.fieldname}_field`] = frappe.ui.form.make_control({\n\t\t\t\tdf: { ...df,\n\t\t\t\t\tonchange: handle_customer_field_change,\n\t\t\t\t},\n\t\t\t\tparent: $customer_form.find(`.${df.fieldname}-field`),\n\t\t\t\trender_input: true,\n\t\t\t});\n\t\t\tthis[`customer_${df.fieldname}_field`].set_value(this.customer_info[df.fieldname]);\n\t\t})\n\n\t\tfunction handle_customer_field_change() {\n\t\t\tconst current_value = me.customer_info[this.df.fieldname];\n\t\t\tconst current_customer = me.customer_info.customer;\n\n\t\t\tif (this.value && current_value != this.value && this.df.fieldname != 'loyalty_points') {\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: 'erpnext.selling.page.point_of_sale.point_of_sale.set_customer_info',\n\t\t\t\t\targs: {\n\t\t\t\t\t\tfieldname: this.df.fieldname,\n\t\t\t\t\t\tcustomer: current_customer,\n\t\t\t\t\t\tvalue: this.value\n\t\t\t\t\t},\n\t\t\t\t\tcallback: (r) => {\n\t\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\t\tme.customer_info[this.df.fieldname] = this.value;\n\t\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\t\tmessage: __(\"Customer contact updated successfully.\"),\n\t\t\t\t\t\t\t\tindicator: 'green'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tfrappe.utils.play_sound(\"submit\");\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tfetch_customer_transactions() {\n\t\tfrappe.db.get_list('POS Invoice', {\n\t\t\tfilters: { customer: this.customer_info.customer, docstatus: 1 },\n\t\t\tfields: ['name', 'grand_total', 'status', 'posting_date', 'posting_time', 'currency'],\n\t\t\tlimit: 20\n\t\t}).then((res) => {\n\t\t\tconst transaction_container = this.$customer_section.find('.customer-transactions');\n\n\t\t\tif (!res.length) {\n\t\t\t\ttransaction_container.html(\n\t\t\t\t\t`<div class=\"no-transactions-placeholder\">No recent transactions found</div>`\n\t\t\t\t)\n\t\t\t\treturn;\n\t\t\t};\n\n\t\t\tconst elapsed_time = moment(res[0].posting_date+\" \"+res[0].posting_time).fromNow();\n\t\t\tthis.$customer_section.find('.customer-desc').html(`Last transacted ${elapsed_time}`);\n\n\t\t\tres.forEach(invoice => {\n\t\t\t\tconst posting_datetime = moment(invoice.posting_date+\" \"+invoice.posting_time).format(\"Do MMMM, h:mma\");\n\t\t\t\tlet indicator_color = {\n\t\t\t\t\t'Paid': 'green',\n\t\t\t\t\t'Draft': 'red',\n\t\t\t\t\t'Return': 'gray',\n\t\t\t\t\t'Consolidated': 'blue'\n\t\t\t\t};\n\n\t\t\t\ttransaction_container.append(\n\t\t\t\t\t`<div class=\"invoice-wrapper\" data-invoice-name=\"${escape(invoice.name)}\">\n\t\t\t\t\t\t<div class=\"invoice-name-date\">\n\t\t\t\t\t\t\t<div class=\"invoice-name\">${invoice.name}</div>\n\t\t\t\t\t\t\t<div class=\"invoice-date\">${posting_datetime}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"invoice-total-status\">\n\t\t\t\t\t\t\t<div class=\"invoice-total\">\n\t\t\t\t\t\t\t\t${format_currency(invoice.grand_total, invoice.currency, 0) || 0}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"invoice-status\">\n\t\t\t\t\t\t\t\t<span class=\"indicator-pill whitespace-nowrap ${indicator_color[invoice.status]}\">\n\t\t\t\t\t\t\t\t\t<span>${invoice.status}</span>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"seperator\"></div>`\n\t\t\t\t)\n\t\t\t});\n\t\t});\n\t}\n\n\tattach_refresh_field_event(frm) {\n\t\t$(frm.wrapper).off('refresh-fields');\n\t\t$(frm.wrapper).on('refresh-fields', () => {\n\t\t\tif (frm.doc.items.length) {\n\t\t\t\tthis.$cart_items_wrapper.html('');\n\t\t\t\tfrm.doc.items.forEach(item => {\n\t\t\t\t\tthis.update_item_html(item);\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.update_totals_section(frm);\n\t\t});\n\t}\n\n\tload_invoice() {\n\t\tconst frm = this.events.get_frm();\n\n\t\tthis.attach_refresh_field_event(frm);\n\n\t\tthis.fetch_customer_details(frm.doc.customer).then(() => {\n\t\t\tthis.events.customer_details_updated(this.customer_info);\n\t\t\tthis.update_customer_section();\n\t\t});\n\n\t\tthis.$cart_items_wrapper.html('');\n\t\tif (frm.doc.items.length) {\n\t\t\tfrm.doc.items.forEach(item => {\n\t\t\t\tthis.update_item_html(item);\n\t\t\t});\n\t\t} else {\n\t\t\tthis.make_no_items_placeholder();\n\t\t\tthis.highlight_checkout_btn(false);\n\t\t}\n\n\t\tthis.update_totals_section(frm);\n\n\t\tif(frm.doc.docstatus === 1) {\n\t\t\tthis.$totals_section.find('.checkout-btn').css('display', 'none');\n\t\t\tthis.$totals_section.find('.edit-cart-btn').css('display', 'none');\n\t\t} else {\n\t\t\tthis.$totals_section.find('.checkout-btn').css('display', 'flex');\n\t\t\tthis.$totals_section.find('.edit-cart-btn').css('display', 'none');\n\t\t}\n\n\t\tthis.toggle_component(true);\n\t}\n\n\ttoggle_component(show) {\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\n\t}\n\n}\n","erpnext.PointOfSale.ItemDetails = class {\n\tconstructor({ wrapper, events, settings }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\t\tthis.hide_images = settings.hide_images;\n\t\tthis.allow_rate_change = settings.allow_rate_change;\n\t\tthis.allow_discount_change = settings.allow_discount_change;\n\t\tthis.current_item = {};\n\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.init_child_components();\n\t\tthis.bind_events();\n\t\tthis.attach_shortcuts();\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"item-details-container\"></section>`\n\t\t)\n\n\t\tthis.$component = this.wrapper.find('.item-details-container');\n\t}\n\n\tinit_child_components() {\n\t\tthis.$component.html(\n\t\t\t`<div class=\"item-details-header\">\n\t\t\t\t<div class=\"label\">${__('Item Details')}</div>\n\t\t\t\t<div class=\"close-btn\">\n\t\t\t\t\t<svg width=\"32\" height=\"32\" viewBox=\"0 0 14 14\" fill=\"none\">\n\t\t\t\t\t\t<path d=\"M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759\" stroke=\"#8D99A6\"/>\n\t\t\t\t\t</svg>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"item-display\">\n\t\t\t\t<div class=\"item-name-desc-price\">\n\t\t\t\t\t<div class=\"item-name\"></div>\n\t\t\t\t\t<div class=\"item-desc\"></div>\n\t\t\t\t\t<div class=\"item-price\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"item-image\"></div>\n\t\t\t</div>\n\t\t\t<div class=\"discount-section\"></div>\n\t\t\t<div class=\"form-container\"></div>`\n\t\t)\n\n\t\tthis.$item_name = this.$component.find('.item-name');\n\t\tthis.$item_description = this.$component.find('.item-desc');\n\t\tthis.$item_price = this.$component.find('.item-price');\n\t\tthis.$item_image = this.$component.find('.item-image');\n\t\tthis.$form_container = this.$component.find('.form-container');\n\t\tthis.$dicount_section = this.$component.find('.discount-section');\n\t}\n\n\tcompare_with_current_item(item) {\n\t\t// returns true if `item` is currently being edited\n\t\treturn item && item.name == this.current_item.name;\n\t}\n\n\tasync toggle_item_details_section(item) {\n\t\tconst current_item_changed = !this.compare_with_current_item(item);\n\n\t\t// if item is null or highlighted cart item is clicked twice\n\t\tconst hide_item_details = !Boolean(item) || !current_item_changed;\n\n\t\tif ((!hide_item_details && current_item_changed) || hide_item_details) {\n\t\t\t// if item details is being closed OR if item details is opened but item is changed\n\t\t\t// in both cases, if the current item is a serialized item, then validate and remove the item\n\t\t\tawait this.validate_serial_batch_item();\n\t\t}\n\n\t\tthis.events.toggle_item_selector(!hide_item_details);\n\t\tthis.toggle_component(!hide_item_details);\n\n\t\tif (item && current_item_changed) {\n\t\t\tthis.doctype = item.doctype;\n\t\t\tthis.item_meta = frappe.get_meta(this.doctype);\n\t\t\tthis.name = item.name;\n\t\t\tthis.item_row = item;\n\t\t\tthis.currency = this.events.get_frm().doc.currency;\n\n\t\t\tthis.current_item = item;\n\n\t\t\tthis.render_dom(item);\n\t\t\tthis.render_discount_dom(item);\n\t\t\tthis.render_form(item);\n\t\t\tthis.events.highlight_cart_item(item);\n\t\t} else {\n\t\t\tthis.current_item = {};\n\t\t}\n\t}\n\n\tvalidate_serial_batch_item() {\n\t\tconst doc = this.events.get_frm().doc;\n\t\tconst item_row = doc.items.find(item => item.name === this.name);\n\n\t\tif (!item_row) return;\n\n\t\tconst serialized = item_row.has_serial_no;\n\t\tconst batched = item_row.has_batch_no;\n\t\tconst no_serial_selected = !item_row.serial_no;\n\t\tconst no_batch_selected = !item_row.batch_no;\n\n\t\tif ((serialized && no_serial_selected) || (batched && no_batch_selected) ||\n\t\t\t(serialized && batched && (no_batch_selected || no_serial_selected))) {\n\n\t\t\tfrappe.show_alert({\n\t\t\t\tmessage: __(\"Item is removed since no serial / batch no selected.\"),\n\t\t\t\tindicator: 'orange'\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"cancel\");\n\t\t\treturn this.events.remove_item_from_cart();\n\t\t}\n\t}\n\n\trender_dom(item) {\n\t\tlet { item_name, description, image, price_list_rate } = item;\n\n\t\tfunction get_description_html() {\n\t\t\tif (description) {\n\t\t\t\tdescription = description.indexOf('...') === -1 && description.length > 140 ? description.substr(0, 139) + '...' : description;\n\t\t\t\treturn description;\n\t\t\t}\n\t\t\treturn ``;\n\t\t}\n\n\t\tthis.$item_name.html(item_name);\n\t\tthis.$item_description.html(get_description_html());\n\t\tthis.$item_price.html(format_currency(price_list_rate, this.currency));\n\t\tif (!this.hide_images && image) {\n\t\t\tthis.$item_image.html(\n\t\t\t\t`<img\n\t\t\t\t\tonerror=\"cur_pos.item_details.handle_broken_image(this)\"\n\t\t\t\t\tclass=\"h-full\" src=\"${image}\"\n\t\t\t\t\talt=\"${frappe.get_abbr(item_name)}\"\n\t\t\t\t\tstyle=\"object-fit: cover;\">`\n\t\t\t);\n\t\t} else {\n\t\t\tthis.$item_image.html(`<div class=\"item-abbr\">${frappe.get_abbr(item_name)}</div>`);\n\t\t}\n\n\t}\n\n\thandle_broken_image($img) {\n\t\tconst item_abbr = $($img).attr('alt');\n\t\t$($img).replaceWith(`<div class=\"item-abbr\">${item_abbr}</div>`);\n\t}\n\n\trender_discount_dom(item) {\n\t\tif (item.discount_percentage) {\n\t\t\tthis.$dicount_section.html(\n\t\t\t\t`<div class=\"item-rate\">${format_currency(item.price_list_rate, this.currency)}</div>\n\t\t\t\t<div class=\"item-discount\">${item.discount_percentage}% off</div>`\n\t\t\t)\n\t\t\tthis.$item_price.html(format_currency(item.rate, this.currency));\n\t\t} else {\n\t\t\tthis.$dicount_section.html(``)\n\t\t}\n\t}\n\n\trender_form(item) {\n\t\tconst fields_to_display = this.get_form_fields(item);\n\t\tthis.$form_container.html('');\n\n\t\tfields_to_display.forEach((fieldname, idx) => {\n\t\t\tthis.$form_container.append(\n\t\t\t\t`<div class=\"${fieldname}-control\" data-fieldname=\"${fieldname}\"></div>`\n\t\t\t)\n\n\t\t\tconst field_meta = this.item_meta.fields.find(df => df.fieldname === fieldname);\n\t\t\tfieldname === 'discount_percentage' ? (field_meta.label = __('Discount (%)')) : '';\n\t\t\tconst me = this;\n\n\t\t\tthis[`${fieldname}_control`] = frappe.ui.form.make_control({\n\t\t\t\tdf: {\n\t\t\t\t\t...field_meta,\n\t\t\t\t\tonchange: function() {\n\t\t\t\t\t\tme.events.form_updated(me.current_item, fieldname, this.value);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tparent: this.$form_container.find(`.${fieldname}-control`),\n\t\t\t\trender_input: true,\n\t\t\t})\n\t\t\tthis[`${fieldname}_control`].set_value(item[fieldname]);\n\t\t});\n\n\t\tthis.make_auto_serial_selection_btn(item);\n\n\t\tthis.bind_custom_control_change_event();\n\t}\n\n\tget_form_fields(item) {\n\t\tconst fields = ['qty', 'uom', 'rate', 'conversion_factor', 'discount_percentage', 'warehouse', 'actual_qty', 'price_list_rate'];\n\t\tif (item.has_serial_no) fields.push('serial_no');\n\t\tif (item.has_batch_no) fields.push('batch_no');\n\t\treturn fields;\n\t}\n\n\tmake_auto_serial_selection_btn(item) {\n\t\tif (item.has_serial_no) {\n\t\t\tif (!item.has_batch_no) {\n\t\t\t\tthis.$form_container.append(\n\t\t\t\t\t`<div class=\"grid-filler no-select\"></div>`\n\t\t\t\t);\n\t\t\t}\n\t\t\tconst label = __('Auto Fetch Serial Numbers');\n\t\t\tthis.$form_container.append(\n\t\t\t\t`<div class=\"btn btn-sm btn-secondary auto-fetch-btn\">${label}</div>`\n\t\t\t);\n\t\t\tthis.$form_container.find('.serial_no-control').find('textarea').css('height', '6rem');\n\t\t}\n\t}\n\n\tbind_custom_control_change_event() {\n\t\tconst me = this;\n\t\tif (this.rate_control) {\n\t\t\tthis.rate_control.df.onchange = function() {\n\t\t\t\tif (this.value || flt(this.value) === 0) {\n\t\t\t\t\tme.events.form_updated(me.current_item, 'rate', this.value).then(() => {\n\t\t\t\t\t\tconst item_row = frappe.get_doc(me.doctype, me.name);\n\t\t\t\t\t\tconst doc = me.events.get_frm().doc;\n\t\t\t\t\t\tme.$item_price.html(format_currency(item_row.rate, doc.currency));\n\t\t\t\t\t\tme.render_discount_dom(item_row);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.rate_control.df.read_only = !this.allow_rate_change;\n\t\t\tthis.rate_control.refresh();\n\t\t}\n\n\t\tif (this.discount_percentage_control && !this.allow_discount_change) {\n\t\t\tthis.discount_percentage_control.df.read_only = 1;\n\t\t\tthis.discount_percentage_control.refresh();\n\t\t}\n\n\t\tif (this.warehouse_control) {\n\t\t\tthis.warehouse_control.df.reqd = 1;\n\t\t\tthis.warehouse_control.df.onchange = function() {\n\t\t\t\tif (this.value) {\n\t\t\t\t\tme.events.form_updated(me.current_item, 'warehouse', this.value).then(() => {\n\t\t\t\t\t\tme.item_stock_map = me.events.get_item_stock_map();\n\t\t\t\t\t\tconst available_qty = me.item_stock_map[me.item_row.item_code][this.value];\n\t\t\t\t\t\tif (available_qty === undefined) {\n\t\t\t\t\t\t\tme.events.get_available_stock(me.item_row.item_code, this.value).then(() => {\n\t\t\t\t\t\t\t\t// item stock map is updated now reset warehouse\n\t\t\t\t\t\t\t\tme.warehouse_control.set_value(this.value);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t} else if (available_qty === 0) {\n\t\t\t\t\t\t\tme.warehouse_control.set_value('');\n\t\t\t\t\t\t\tconst bold_item_code = me.item_row.item_code.bold();\n\t\t\t\t\t\t\tconst bold_warehouse = this.value.bold();\n\t\t\t\t\t\t\tfrappe.throw(\n\t\t\t\t\t\t\t\t__('Item Code: {0} is not available under warehouse {1}.', [bold_item_code, bold_warehouse])\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tme.actual_qty_control.set_value(available_qty);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.warehouse_control.df.get_query = () => {\n\t\t\t\treturn {\n\t\t\t\t\tfilters: { company: this.events.get_frm().doc.company }\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.warehouse_control.refresh();\n\t\t}\n\n\t\tif (this.serial_no_control) {\n\t\t\tthis.serial_no_control.df.reqd = 1;\n\t\t\tthis.serial_no_control.df.onchange = async function() {\n\t\t\t\t!me.current_item.batch_no && await me.auto_update_batch_no();\n\t\t\t\tme.events.form_updated(me.current_item, 'serial_no', this.value);\n\t\t\t}\n\t\t\tthis.serial_no_control.refresh();\n\t\t}\n\n\t\tif (this.batch_no_control) {\n\t\t\tthis.batch_no_control.df.reqd = 1;\n\t\t\tthis.batch_no_control.df.get_query = () => {\n\t\t\t\treturn {\n\t\t\t\t\tquery: 'erpnext.controllers.queries.get_batch_no',\n\t\t\t\t\tfilters: {\n\t\t\t\t\t\titem_code: me.item_row.item_code,\n\t\t\t\t\t\twarehouse: me.item_row.warehouse,\n\t\t\t\t\t\tposting_date: me.events.get_frm().doc.posting_date\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.batch_no_control.refresh();\n\t\t}\n\n\t\tif (this.uom_control) {\n\t\t\tthis.uom_control.df.onchange = function() {\n\t\t\t\tme.events.form_updated(me.current_item, 'uom', this.value);\n\n\t\t\t\tconst item_row = frappe.get_doc(me.doctype, me.name);\n\t\t\t\tme.conversion_factor_control.df.read_only = (item_row.stock_uom == this.value);\n\t\t\t\tme.conversion_factor_control.refresh();\n\t\t\t}\n\t\t}\n\n\t\tfrappe.model.on(\"POS Invoice Item\", \"*\", (fieldname, value, item_row) => {\n\t\t\tconst field_control = this[`${fieldname}_control`];\n\t\t\tconst item_row_is_being_edited = this.compare_with_current_item(item_row);\n\n\t\t\tif (item_row_is_being_edited && field_control && field_control.get_value() !== value) {\n\t\t\t\tfield_control.set_value(value);\n\t\t\t\tcur_pos.update_cart_html(item_row);\n\t\t\t}\n\t\t});\n\t}\n\n\tasync auto_update_batch_no() {\n\t\tif (this.serial_no_control && this.batch_no_control) {\n\t\t\tconst selected_serial_nos = this.serial_no_control.get_value().split(`\\n`).filter(s => s);\n\t\t\tif (!selected_serial_nos.length) return;\n\n\t\t\t// find batch nos of the selected serial no\n\t\t\tconst serials_with_batch_no = await frappe.db.get_list(\"Serial No\", {\n\t\t\t\tfilters: { 'name': [\"in\", selected_serial_nos]},\n\t\t\t\tfields: [\"batch_no\", \"name\"]\n\t\t\t});\n\t\t\tconst batch_serial_map = serials_with_batch_no.reduce((acc, r) => {\n\t\t\t\tif (!acc[r.batch_no]) {\n\t\t\t\t\tacc[r.batch_no] = [];\n\t\t\t\t}\n\t\t\t\tacc[r.batch_no] = [...acc[r.batch_no], r.name];\n\t\t\t\treturn acc;\n\t\t\t}, {});\n\t\t\t// set current item's batch no and serial no\n\t\t\tconst batch_no = Object.keys(batch_serial_map)[0];\n\t\t\tconst batch_serial_nos = batch_serial_map[batch_no].join(`\\n`);\n\t\t\t// eg. 10 selected serial no. -> 5 belongs to first batch other 5 belongs to second batch\n\t\t\tconst serial_nos_belongs_to_other_batch = selected_serial_nos.length !== batch_serial_map[batch_no].length;\n\n\t\t\tconst current_batch_no = this.batch_no_control.get_value();\n\t\t\tcurrent_batch_no != batch_no && await this.batch_no_control.set_value(batch_no);\n\n\t\t\tif (serial_nos_belongs_to_other_batch) {\n\t\t\t\tthis.serial_no_control.set_value(batch_serial_nos);\n\t\t\t\tthis.qty_control.set_value(batch_serial_map[batch_no].length);\n\n\t\t\t\tdelete batch_serial_map[batch_no];\n\t\t\t\tthis.events.clone_new_batch_item_in_frm(batch_serial_map, this.current_item);\n\t\t\t}\n\t\t}\n\t}\n\n\tbind_events() {\n\t\tthis.bind_auto_serial_fetch_event();\n\t\tthis.bind_fields_to_numpad_fields();\n\n\t\tthis.$component.on('click', '.close-btn', () => {\n\t\t\tthis.events.close_item_details();\n\t\t});\n\t}\n\n\tattach_shortcuts() {\n\t\tthis.wrapper.find('.close-btn').attr(\"title\", \"Esc\");\n\t\tfrappe.ui.keys.on(\"escape\", () => {\n\t\t\tconst item_details_visible = this.$component.is(\":visible\");\n\t\t\tif (item_details_visible) {\n\t\t\t\tthis.events.close_item_details();\n\t\t\t}\n\t\t});\n\t}\n\n\tbind_fields_to_numpad_fields() {\n\t\tconst me = this;\n\t\tthis.$form_container.on('click', '.input-with-feedback', function() {\n\t\t\tconst fieldname = $(this).attr('data-fieldname');\n\t\t\tif (this.last_field_focused != fieldname) {\n\t\t\t\tme.events.item_field_focused(fieldname);\n\t\t\t\tthis.last_field_focused = fieldname;\n\t\t\t}\n\t\t});\n\t}\n\n\tbind_auto_serial_fetch_event() {\n\t\tthis.$form_container.on('click', '.auto-fetch-btn', () => {\n\t\t\tthis.batch_no_control && this.batch_no_control.set_value('');\n\t\t\tlet qty = this.qty_control.get_value();\n\t\t\tlet conversion_factor = this.conversion_factor_control.get_value();\n\t\t\tlet expiry_date = this.item_row.has_batch_no ? this.events.get_frm().doc.posting_date : \"\";\n\n\t\t\tlet numbers = frappe.call({\n\t\t\t\tmethod: \"erpnext.stock.doctype.serial_no.serial_no.auto_fetch_serial_number\",\n\t\t\t\targs: {\n\t\t\t\t\tqty: qty * conversion_factor,\n\t\t\t\t\titem_code: this.current_item.item_code,\n\t\t\t\t\twarehouse: this.warehouse_control.get_value() || '',\n\t\t\t\t\tbatch_nos: this.current_item.batch_no || '',\n\t\t\t\t\tposting_date: expiry_date,\n\t\t\t\t\tfor_doctype: 'POS Invoice'\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tnumbers.then((data) => {\n\t\t\t\tlet auto_fetched_serial_numbers = data.message;\n\t\t\t\tlet records_length = auto_fetched_serial_numbers.length;\n\t\t\t\tif (!records_length) {\n\t\t\t\t\tconst warehouse = this.warehouse_control.get_value().bold();\n\t\t\t\t\tconst item_code = this.current_item.item_code.bold();\n\t\t\t\t\tfrappe.msgprint(\n\t\t\t\t\t\t__('Serial numbers unavailable for Item {0} under warehouse {1}. Please try changing warehouse.', [item_code, warehouse])\n\t\t\t\t\t);\n\t\t\t\t} else if (records_length < qty) {\n\t\t\t\t\tfrappe.msgprint(\n\t\t\t\t\t\t__('Fetched only {0} available serial numbers.', [records_length])\n\t\t\t\t\t);\n\t\t\t\t\tthis.qty_control.set_value(records_length);\n\t\t\t\t}\n\t\t\t\tnumbers = auto_fetched_serial_numbers.join(`\\n`);\n\t\t\t\tthis.serial_no_control.set_value(numbers);\n\t\t\t});\n\t\t})\n\t}\n\n\ttoggle_component(show) {\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\n\t}\n}\n","erpnext.PointOfSale.NumberPad = class {\n\tconstructor({ wrapper, events, cols, keys, css_classes, fieldnames_map }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\t\tthis.cols = cols;\n\t\tthis.keys = keys;\n\t\tthis.css_classes = css_classes || [];\n\t\tthis.fieldnames = fieldnames_map || {};\n\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.bind_events();\n\t}\n\n\tprepare_dom() {\n\t\tconst { cols, keys, css_classes, fieldnames } = this;\n\n\t\tfunction get_keys() {\n\t\t\treturn keys.reduce((a, row, i) => {\n\t\t\t\treturn a + row.reduce((a2, number, j) => {\n\t\t\t\t\tconst class_to_append = css_classes && css_classes[i] ? css_classes[i][j] : '';\n\t\t\t\t\tconst fieldname = fieldnames && fieldnames[number] ?\n\t\t\t\t\t\tfieldnames[number] : typeof number === 'string' ? frappe.scrub(number) : number;\n\n\t\t\t\t\treturn a2 + `<div class=\"numpad-btn ${class_to_append}\" data-button-value=\"${fieldname}\">${__(number)}</div>`;\n\t\t\t\t}, '');\n\t\t\t}, '');\n\t\t}\n\n\t\tthis.wrapper.html(\n\t\t\t`<div class=\"numpad-container\">\n\t\t\t\t${get_keys()}\n\t\t\t</div>`\n\t\t)\n\t}\n\n\tbind_events() {\n\t\tconst me = this;\n\t\tthis.wrapper.on('click', '.numpad-btn', function() {\n\t\t\tconst $btn = $(this);\n\t\t\tme.events.numpad_event($btn);\n\t\t});\n\t}\n}\n","/* eslint-disable no-unused-vars */\nerpnext.PointOfSale.Payment = class {\n\tconstructor({ events, wrapper }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.initialize_numpad();\n\t\tthis.bind_events();\n\t\tthis.attach_shortcuts();\n\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"payment-container\">\n\t\t\t\t<div class=\"section-label payment-section\">${__('Payment Method')}</div>\n\t\t\t\t<div class=\"payment-modes\"></div>\n\t\t\t\t<div class=\"fields-numpad-container\">\n\t\t\t\t\t<div class=\"fields-section\">\n\t\t\t\t\t\t<div class=\"section-label\">${__('Additional Information')}</div>\n\t\t\t\t\t\t<div class=\"invoice-fields\"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"number-pad\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"totals-section\">\n\t\t\t\t\t<div class=\"totals\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"submit-order-btn\">${__(\"Complete Order\")}</div>\n\t\t\t</section>`\n\t\t);\n\t\tthis.$component = this.wrapper.find('.payment-container');\n\t\tthis.$payment_modes = this.$component.find('.payment-modes');\n\t\tthis.$totals_section = this.$component.find('.totals-section');\n\t\tthis.$totals = this.$component.find('.totals');\n\t\tthis.$numpad = this.$component.find('.number-pad');\n\t\tthis.$invoice_fields_section = this.$component.find('.fields-section');\n\t}\n\n\tmake_invoice_fields_control() {\n\t\tfrappe.db.get_doc(\"POS Settings\", undefined).then((doc) => {\n\t\t\tconst fields = doc.invoice_fields;\n\t\t\tif (!fields.length) return;\n\n\t\t\tthis.$invoice_fields = this.$invoice_fields_section.find('.invoice-fields');\n\t\t\tthis.$invoice_fields.html('');\n\t\t\tconst frm = this.events.get_frm();\n\n\t\t\tfields.forEach(df => {\n\t\t\t\tthis.$invoice_fields.append(\n\t\t\t\t\t`<div class=\"invoice_detail_field ${df.fieldname}-field\" data-fieldname=\"${df.fieldname}\"></div>`\n\t\t\t\t);\n\t\t\t\tlet df_events = {\n\t\t\t\t\tonchange: function() {\n\t\t\t\t\t\tfrm.set_value(this.df.fieldname, this.get_value());\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tif (df.fieldtype == \"Button\") {\n\t\t\t\t\tdf_events = {\n\t\t\t\t\t\tclick: function() {\n\t\t\t\t\t\t\tif (frm.script_manager.has_handlers(df.fieldname, frm.doc.doctype)) {\n\t\t\t\t\t\t\t\tfrm.script_manager.trigger(df.fieldname, frm.doc.doctype, frm.doc.docname);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tthis[`${df.fieldname}_field`] = frappe.ui.form.make_control({\n\t\t\t\t\tdf: {\n\t\t\t\t\t\t...df,\n\t\t\t\t\t\t...df_events\n\t\t\t\t\t},\n\t\t\t\t\tparent: this.$invoice_fields.find(`.${df.fieldname}-field`),\n\t\t\t\t\trender_input: true,\n\t\t\t\t});\n\t\t\t\tthis[`${df.fieldname}_field`].set_value(frm.doc[df.fieldname]);\n\t\t\t});\n\t\t});\n\t}\n\n\tinitialize_numpad() {\n\t\tconst me = this;\n\t\tthis.number_pad = new erpnext.PointOfSale.NumberPad({\n\t\t\twrapper: this.$numpad,\n\t\t\tevents: {\n\t\t\t\tnumpad_event: function($btn) {\n\t\t\t\t\tme.on_numpad_clicked($btn);\n\t\t\t\t}\n\t\t\t},\n\t\t\tcols: 3,\n\t\t\tkeys: [\n\t\t\t\t[ 1, 2, 3 ],\n\t\t\t\t[ 4, 5, 6 ],\n\t\t\t\t[ 7, 8, 9 ],\n\t\t\t\t[ '.', 0, 'Delete' ]\n\t\t\t],\n\t\t});\n\n\t\tthis.numpad_value = '';\n\t}\n\n\ton_numpad_clicked($btn) {\n\t\tconst button_value = $btn.attr('data-button-value');\n\n\t\thighlight_numpad_btn($btn);\n\t\tthis.numpad_value = button_value === 'delete' ? this.numpad_value.slice(0, -1) : this.numpad_value + button_value;\n\t\tthis.selected_mode.$input.get(0).focus();\n\t\tthis.selected_mode.set_value(this.numpad_value);\n\n\t\tfunction highlight_numpad_btn($btn) {\n\t\t\t$btn.addClass('shadow-base-inner bg-selected');\n\t\t\tsetTimeout(() => {\n\t\t\t\t$btn.removeClass('shadow-base-inner bg-selected');\n\t\t\t}, 100);\n\t\t}\n\t}\n\n\tbind_events() {\n\t\tconst me = this;\n\n\t\tthis.$payment_modes.on('click', '.mode-of-payment', function(e) {\n\t\t\tconst mode_clicked = $(this);\n\t\t\t// if clicked element doesn't have .mode-of-payment class then return\n\t\t\tif (!$(e.target).is(mode_clicked)) return;\n\n\t\t\tconst scrollLeft = mode_clicked.offset().left - me.$payment_modes.offset().left + me.$payment_modes.scrollLeft();\n\t\t\tme.$payment_modes.animate({ scrollLeft });\n\n\t\t\tconst mode = mode_clicked.attr('data-mode');\n\n\t\t\t// hide all control fields and shortcuts\n\t\t\t$(`.mode-of-payment-control`).css('display', 'none');\n\t\t\t$(`.cash-shortcuts`).css('display', 'none');\n\t\t\tme.$payment_modes.find(`.pay-amount`).css('display', 'inline');\n\t\t\tme.$payment_modes.find(`.loyalty-amount-name`).css('display', 'none');\n\n\t\t\t// remove highlight from all mode-of-payments\n\t\t\t$('.mode-of-payment').removeClass('border-primary');\n\n\t\t\tif (mode_clicked.hasClass('border-primary')) {\n\t\t\t\t// clicked one is selected then unselect it\n\t\t\t\tmode_clicked.removeClass('border-primary');\n\t\t\t\tme.selected_mode = '';\n\t\t\t} else {\n\t\t\t\t// clicked one is not selected then select it\n\t\t\t\tmode_clicked.addClass('border-primary');\n\t\t\t\tmode_clicked.find('.mode-of-payment-control').css('display', 'flex');\n\t\t\t\tmode_clicked.find('.cash-shortcuts').css('display', 'grid');\n\t\t\t\tme.$payment_modes.find(`.${mode}-amount`).css('display', 'none');\n\t\t\t\tme.$payment_modes.find(`.${mode}-name`).css('display', 'inline');\n\n\t\t\t\tme.selected_mode = me[`${mode}_control`];\n\t\t\t\tme.selected_mode && me.selected_mode.$input.get(0).focus();\n\t\t\t\tme.auto_set_remaining_amount();\n\t\t\t}\n\t\t});\n\n\t\tfrappe.ui.form.on('POS Invoice', 'contact_mobile', (frm) => {\n\t\t\tconst contact = frm.doc.contact_mobile;\n\t\t\tconst request_button = $(this.request_for_payment_field.$input[0]);\n\t\t\tif (contact) {\n\t\t\t\trequest_button.removeClass('btn-default').addClass('btn-primary');\n\t\t\t} else {\n\t\t\t\trequest_button.removeClass('btn-primary').addClass('btn-default');\n      }\n    });\n\n\t\tfrappe.ui.form.on('POS Invoice', 'coupon_code', (frm) => {\n\t\t\tif (frm.doc.coupon_code && !frm.applying_pos_coupon_code) {\n\t\t\t\tif (!frm.doc.ignore_pricing_rule) {\n\t\t\t\t\tfrm.applying_pos_coupon_code = true;\n\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t() => frm.doc.ignore_pricing_rule=1,\n\t\t\t\t\t\t() => frm.trigger('ignore_pricing_rule'),\n\t\t\t\t\t\t() => frm.doc.ignore_pricing_rule=0,\n\t\t\t\t\t\t() => frm.trigger('apply_pricing_rule'),\n\t\t\t\t\t\t() => frm.save(),\n\t\t\t\t\t\t() => this.update_totals_section(frm.doc),\n\t\t\t\t\t\t() => (frm.applying_pos_coupon_code = false)\n\t\t\t\t\t]);\n\t\t\t\t} else if (frm.doc.ignore_pricing_rule) {\n\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\tmessage: __(\"Ignore Pricing Rule is enabled. Cannot apply coupon code.\"),\n\t\t\t\t\t\tindicator: \"orange\"\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.setup_listener_for_payments();\n\n\t\tthis.$payment_modes.on('click', '.shortcut', function() {\n\t\t\tconst value = $(this).attr('data-value');\n\t\t\tme.selected_mode.set_value(value);\n\t\t});\n\n\t\tthis.$component.on('click', '.submit-order-btn', () => {\n\t\t\tconst doc = this.events.get_frm().doc;\n\t\t\tconst paid_amount = doc.paid_amount;\n\t\t\tconst items = doc.items;\n\n\t\t\tif (paid_amount == 0 || !items.length) {\n\t\t\t\tconst message = items.length ? __(\"You cannot submit the order without payment.\") : __(\"You cannot submit empty order.\");\n\t\t\t\tfrappe.show_alert({ message, indicator: \"orange\" });\n\t\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.events.submit_invoice();\n\t\t});\n\n\t\tfrappe.ui.form.on('POS Invoice', 'paid_amount', (frm) => {\n\t\t\tthis.update_totals_section(frm.doc);\n\n\t\t\t// need to re calculate cash shortcuts after discount is applied\n\t\t\tconst is_cash_shortcuts_invisible = !this.$payment_modes.find('.cash-shortcuts').is(':visible');\n\t\t\tthis.attach_cash_shortcuts(frm.doc);\n\t\t\t!is_cash_shortcuts_invisible && this.$payment_modes.find('.cash-shortcuts').css('display', 'grid');\n\t\t\tthis.render_payment_mode_dom();\n\t\t});\n\n\t\tfrappe.ui.form.on('POS Invoice', 'loyalty_amount', (frm) => {\n\t\t\tconst formatted_currency = format_currency(frm.doc.loyalty_amount, frm.doc.currency);\n\t\t\tthis.$payment_modes.find(`.loyalty-amount-amount`).html(formatted_currency);\n\t\t});\n\n\t\tfrappe.ui.form.on(\"Sales Invoice Payment\", \"amount\", (frm, cdt, cdn) => {\n\t\t\t// for setting correct amount after loyalty points are redeemed\n\t\t\tconst default_mop = locals[cdt][cdn];\n\t\t\tconst mode = default_mop.mode_of_payment.replace(/ +/g, \"_\").toLowerCase();\n\t\t\tif (this[`${mode}_control`] && this[`${mode}_control`].get_value() != default_mop.amount) {\n\t\t\t\tthis[`${mode}_control`].set_value(default_mop.amount);\n\t\t\t}\n\t\t});\n\t}\n\n\tsetup_listener_for_payments() {\n\t\tfrappe.realtime.on(\"process_phone_payment\", (data) => {\n\t\t\tconst doc = this.events.get_frm().doc;\n\t\t\tconst { response, amount, success, failure_message } = data;\n\t\t\tlet message, title;\n\n\t\t\tif (success) {\n\t\t\t\ttitle = __(\"Payment Received\");\n\t\t\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\n\t\t\t\tif (amount >= grand_total) {\n\t\t\t\t\tfrappe.dom.unfreeze();\n\t\t\t\t\tmessage = __(\"Payment of {0} received successfully.\", [format_currency(amount, doc.currency, 0)]);\n\t\t\t\t\tthis.events.submit_invoice();\n\t\t\t\t\tcur_frm.reload_doc();\n\n\t\t\t\t} else {\n\t\t\t\t\tmessage = __(\"Payment of {0} received successfully. Waiting for other requests to complete...\", [format_currency(amount, doc.currency, 0)]);\n\t\t\t\t}\n\t\t\t} else if (failure_message) {\n\t\t\t\tmessage = failure_message;\n\t\t\t\ttitle = __(\"Payment Failed\");\n\t\t\t}\n\n\t\t\tfrappe.msgprint({ \"message\": message, \"title\": title });\n\t\t});\n\t}\n\n\tauto_set_remaining_amount() {\n\t\tconst doc = this.events.get_frm().doc;\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\n\t\tconst remaining_amount = grand_total - doc.paid_amount;\n\t\tconst current_value = this.selected_mode ? this.selected_mode.get_value() : undefined;\n\t\tif (!current_value && remaining_amount > 0 && this.selected_mode) {\n\t\t\tthis.selected_mode.set_value(remaining_amount);\n\t\t}\n\t}\n\n\tattach_shortcuts() {\n\t\tconst ctrl_label = frappe.utils.is_mac() ? '⌘' : 'Ctrl';\n\t\tthis.$component.find('.submit-order-btn').attr(\"title\", `${ctrl_label}+Enter`);\n\t\tfrappe.ui.keys.on(\"ctrl+enter\", () => {\n\t\t\tconst payment_is_visible = this.$component.is(\":visible\");\n\t\t\tconst active_mode = this.$payment_modes.find(\".border-primary\");\n\t\t\tif (payment_is_visible && active_mode.length) {\n\t\t\t\tthis.$component.find('.submit-order-btn').click();\n\t\t\t}\n\t\t});\n\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"tab\",\n\t\t\taction: () => {\n\t\t\t\tconst payment_is_visible = this.$component.is(\":visible\");\n\t\t\t\tlet active_mode = this.$payment_modes.find(\".border-primary\");\n\t\t\t\tactive_mode = active_mode.length ? active_mode.attr(\"data-mode\") : undefined;\n\n\t\t\t\tif (!active_mode) return;\n\n\t\t\t\tconst mode_of_payments = Array.from(this.$payment_modes.find(\".mode-of-payment\")).map(m => $(m).attr(\"data-mode\"));\n\t\t\t\tconst mode_index = mode_of_payments.indexOf(active_mode);\n\t\t\t\tconst next_mode_index = (mode_index + 1) % mode_of_payments.length;\n\t\t\t\tconst next_mode_to_be_clicked = this.$payment_modes.find(`.mode-of-payment[data-mode=\"${mode_of_payments[next_mode_index]}\"]`);\n\n\t\t\t\tif (payment_is_visible && mode_index != next_mode_index) {\n\t\t\t\t\tnext_mode_to_be_clicked.click();\n\t\t\t\t}\n\t\t\t},\n\t\t\tcondition: () => this.$component.is(':visible') && this.$payment_modes.find(\".border-primary\").length,\n\t\t\tdescription: __(\"Switch Between Payment Modes\"),\n\t\t\tignore_inputs: true,\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t}\n\n\ttoggle_numpad() {\n\t\t// pass\n\t}\n\n\trender_payment_section() {\n\t\tthis.render_payment_mode_dom();\n\t\tthis.make_invoice_fields_control();\n\t\tthis.update_totals_section();\n\t\tthis.focus_on_default_mop();\n\t}\n\n\tedit_cart() {\n\t\tthis.events.toggle_other_sections(false);\n\t\tthis.toggle_component(false);\n\t}\n\n\tcheckout() {\n\t\tthis.events.toggle_other_sections(true);\n\t\tthis.toggle_component(true);\n\n\t\tthis.render_payment_section();\n\t}\n\n\ttoggle_remarks_control() {\n\t\tif (this.$remarks.find('.frappe-control').length) {\n\t\t\tthis.$remarks.html('+ Add Remark');\n\t\t} else {\n\t\t\tthis.$remarks.html('');\n\t\t\tthis[`remark_control`] = frappe.ui.form.make_control({\n\t\t\t\tdf: {\n\t\t\t\t\tlabel: __('Remark'),\n\t\t\t\t\tfieldtype: 'Data',\n\t\t\t\t\tonchange: function() {}\n\t\t\t\t},\n\t\t\t\tparent: this.$totals_section.find(`.remarks`),\n\t\t\t\trender_input: true,\n\t\t\t});\n\t\t\tthis[`remark_control`].set_value('');\n\t\t}\n\t}\n\n\trender_payment_mode_dom() {\n\t\tconst doc = this.events.get_frm().doc;\n\t\tconst payments = doc.payments;\n\t\tconst currency = doc.currency;\n\n\t\tthis.$payment_modes.html(`${\n\t\t\tpayments.map((p, i) => {\n\t\t\t\tconst mode = p.mode_of_payment.replace(/ +/g, \"_\").toLowerCase();\n\t\t\t\tconst payment_type = p.type;\n\t\t\t\tconst margin = i % 2 === 0 ? 'pr-2' : 'pl-2';\n\t\t\t\tconst amount = p.amount > 0 ? format_currency(p.amount, currency) : '';\n\n\t\t\t\treturn (`\n\t\t\t\t\t<div class=\"payment-mode-wrapper\">\n\t\t\t\t\t\t<div class=\"mode-of-payment\" data-mode=\"${mode}\" data-payment-type=\"${payment_type}\">\n\t\t\t\t\t\t\t${p.mode_of_payment}\n\t\t\t\t\t\t\t<div class=\"${mode}-amount pay-amount\">${amount}</div>\n\t\t\t\t\t\t\t<div class=\"${mode} mode-of-payment-control\"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t`);\n\t\t\t}).join('')\n\t\t}`);\n\n\t\tpayments.forEach(p => {\n\t\t\tconst mode = p.mode_of_payment.replace(/ +/g, \"_\").toLowerCase();\n\t\t\tconst me = this;\n\t\t\tthis[`${mode}_control`] = frappe.ui.form.make_control({\n\t\t\t\tdf: {\n\t\t\t\t\tlabel: p.mode_of_payment,\n\t\t\t\t\tfieldtype: 'Currency',\n\t\t\t\t\tplaceholder: __('Enter {0} amount.', [p.mode_of_payment]),\n\t\t\t\t\tonchange: function() {\n\t\t\t\t\t\tconst current_value = frappe.model.get_value(p.doctype, p.name, 'amount');\n\t\t\t\t\t\tif (current_value != this.value) {\n\t\t\t\t\t\t\tfrappe.model\n\t\t\t\t\t\t\t\t.set_value(p.doctype, p.name, 'amount', flt(this.value))\n\t\t\t\t\t\t\t\t.then(() => me.update_totals_section())\n\n\t\t\t\t\t\t\tconst formatted_currency = format_currency(this.value, currency);\n\t\t\t\t\t\t\tme.$payment_modes.find(`.${mode}-amount`).html(formatted_currency);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tparent: this.$payment_modes.find(`.${mode}.mode-of-payment-control`),\n\t\t\t\trender_input: true,\n\t\t\t});\n\t\t\tthis[`${mode}_control`].toggle_label(false);\n\t\t\tthis[`${mode}_control`].set_value(p.amount);\n\t\t});\n\n\t\tthis.render_loyalty_points_payment_mode();\n\n\t\tthis.attach_cash_shortcuts(doc);\n\t}\n\n\tfocus_on_default_mop() {\n\t\tconst doc = this.events.get_frm().doc;\n\t\tconst payments = doc.payments;\n\t\tpayments.forEach(p => {\n\t\t\tconst mode = p.mode_of_payment.replace(/ +/g, \"_\").toLowerCase();\n\t\t\tif (p.default) {\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tthis.$payment_modes.find(`.${mode}.mode-of-payment-control`).parent().click();\n\t\t\t\t}, 500);\n\t\t\t}\n\t\t});\n\t}\n\n\tattach_cash_shortcuts(doc) {\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\n\t\tconst currency = doc.currency;\n\n\t\tconst shortcuts = this.get_cash_shortcuts(flt(grand_total));\n\n\t\tthis.$payment_modes.find('.cash-shortcuts').remove();\n\t\tlet shortcuts_html = shortcuts.map(s => {\n\t\t\treturn `<div class=\"shortcut\" data-value=\"${s}\">${format_currency(s, currency, 0)}</div>`;\n\t\t}).join('');\n\n\t\tthis.$payment_modes.find('[data-payment-type=\"Cash\"]').find('.mode-of-payment-control')\n\t\t\t.after(`<div class=\"cash-shortcuts\">${shortcuts_html}</div>`);\n\t}\n\n\tget_cash_shortcuts(grand_total) {\n\t\tlet steps = [1, 5, 10];\n\t\tconst digits = String(Math.round(grand_total)).length;\n\n\t\tsteps = steps.map(x => x * (10 ** (digits - 2)));\n\n\t\tconst get_nearest = (amount, x) => {\n\t\t\tlet nearest_x = Math.ceil((amount / x)) * x;\n\t\t\treturn nearest_x === amount ? nearest_x + x : nearest_x;\n\t\t};\n\n\t\treturn steps.reduce((finalArr, x) => {\n\t\t\tlet nearest_x = get_nearest(grand_total, x);\n\t\t\tnearest_x = finalArr.indexOf(nearest_x) != -1 ? nearest_x + x : nearest_x;\n\t\t\treturn [...finalArr, nearest_x];\n\t\t}, []);\n\t}\n\n\trender_loyalty_points_payment_mode() {\n\t\tconst me = this;\n\t\tconst doc = this.events.get_frm().doc;\n\t\tconst { loyalty_program, loyalty_points, conversion_factor } = this.events.get_customer_details();\n\n\t\tthis.$payment_modes.find(`.mode-of-payment[data-mode=\"loyalty-amount\"]`).parent().remove();\n\n\t\tif (!loyalty_program) return;\n\n\t\tlet description, read_only, max_redeemable_amount;\n\t\tif (!loyalty_points) {\n\t\t\tdescription = __(\"You don't have enough points to redeem.\");\n\t\t\tread_only = true;\n\t\t} else {\n\t\t\tmax_redeemable_amount = flt(flt(loyalty_points) * flt(conversion_factor), precision(\"loyalty_amount\", doc));\n\t\t\tdescription = __(\"You can redeem upto {0}.\", [format_currency(max_redeemable_amount)]);\n\t\t\tread_only = false;\n\t\t}\n\n\t\tconst margin = this.$payment_modes.children().length % 2 === 0 ? 'pr-2' : 'pl-2';\n\t\tconst amount = doc.loyalty_amount > 0 ? format_currency(doc.loyalty_amount, doc.currency) : '';\n\t\tthis.$payment_modes.append(\n\t\t\t`<div class=\"payment-mode-wrapper\">\n\t\t\t\t<div class=\"mode-of-payment loyalty-card\" data-mode=\"loyalty-amount\" data-payment-type=\"loyalty-amount\">\n\t\t\t\t\tRedeem Loyalty Points\n\t\t\t\t\t<div class=\"loyalty-amount-amount pay-amount\">${amount}</div>\n\t\t\t\t\t<div class=\"loyalty-amount-name\">${loyalty_program}</div>\n\t\t\t\t\t<div class=\"loyalty-amount mode-of-payment-control\"></div>\n\t\t\t\t</div>\n\t\t\t</div>`\n\t\t);\n\n\t\tthis['loyalty-amount_control'] = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __(\"Redeem Loyalty Points\"),\n\t\t\t\tfieldtype: 'Currency',\n\t\t\t\tplaceholder: __(\"Enter amount to be redeemed.\"),\n\t\t\t\toptions: 'company:currency',\n\t\t\t\tread_only,\n\t\t\t\tonchange: async function() {\n\t\t\t\t\tif (!loyalty_points) return;\n\n\t\t\t\t\tif (this.value > max_redeemable_amount) {\n\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\tmessage: __(\"You cannot redeem more than {0}.\", [format_currency(max_redeemable_amount)]),\n\t\t\t\t\t\t\tindicator: \"red\"\n\t\t\t\t\t\t});\n\t\t\t\t\t\tfrappe.utils.play_sound(\"submit\");\n\t\t\t\t\t\tme['loyalty-amount_control'].set_value(0);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst redeem_loyalty_points = this.value > 0 ? 1 : 0;\n\t\t\t\t\tawait frappe.model.set_value(doc.doctype, doc.name, 'redeem_loyalty_points', redeem_loyalty_points);\n\t\t\t\t\tfrappe.model.set_value(doc.doctype, doc.name, 'loyalty_points', parseInt(this.value / conversion_factor));\n\t\t\t\t},\n\t\t\t\tdescription\n\t\t\t},\n\t\t\tparent: this.$payment_modes.find(`.loyalty-amount.mode-of-payment-control`),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis['loyalty-amount_control'].toggle_label(false);\n\n\t\t// this.render_add_payment_method_dom();\n\t}\n\n\trender_add_payment_method_dom() {\n\t\tconst docstatus = this.events.get_frm().doc.docstatus;\n\t\tif (docstatus === 0)\n\t\t\tthis.$payment_modes.append(\n\t\t\t\t`<div class=\"w-full pr-2\">\n\t\t\t\t\t<div class=\"add-mode-of-payment w-half text-grey mb-4 no-select pointer\">+ Add Payment Method</div>\n\t\t\t\t</div>`\n\t\t\t);\n\t}\n\n\tupdate_totals_section(doc) {\n\t\tif (!doc) doc = this.events.get_frm().doc;\n\t\tconst paid_amount = doc.paid_amount;\n\t\tconst grand_total = cint(frappe.sys_defaults.disable_rounded_total) ? doc.grand_total : doc.rounded_total;\n\t\tconst remaining = grand_total - doc.paid_amount;\n\t\tconst change = doc.change_amount || remaining <= 0 ? -1 * remaining : undefined;\n\t\tconst currency = doc.currency;\n\t\tconst label = change ? __('Change') : __('To Be Paid');\n\n\t\tthis.$totals.html(\n\t\t\t`<div class=\"col\">\n\t\t\t\t<div class=\"total-label\">${__('Grand Total')}</div>\n\t\t\t\t<div class=\"value\">${format_currency(grand_total, currency)}</div>\n\t\t\t</div>\n\t\t\t<div class=\"seperator-y\"></div>\n\t\t\t<div class=\"col\">\n\t\t\t\t<div class=\"total-label\">${__('Paid Amount')}</div>\n\t\t\t\t<div class=\"value\">${format_currency(paid_amount, currency)}</div>\n\t\t\t</div>\n\t\t\t<div class=\"seperator-y\"></div>\n\t\t\t<div class=\"col\">\n\t\t\t\t<div class=\"total-label\">${label}</div>\n\t\t\t\t<div class=\"value\">${format_currency(change || remaining, currency)}</div>\n\t\t\t</div>`\n\t\t);\n\t}\n\n\ttoggle_component(show) {\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\n\t}\n};\n","erpnext.PointOfSale.PastOrderList = class {\n\tconstructor({ wrapper, events }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.make_filter_section();\n\t\tthis.bind_events();\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"past-order-list\">\n\t\t\t\t<div class=\"filter-section\">\n\t\t\t\t\t<div class=\"label\">${__('Recent Orders')}</div>\n\t\t\t\t\t<div class=\"search-field\"></div>\n\t\t\t\t\t<div class=\"status-field\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"invoices-container\"></div>\n\t\t\t</section>`\n\t\t);\n\n\t\tthis.$component = this.wrapper.find('.past-order-list');\n\t\tthis.$invoices_container = this.$component.find('.invoices-container');\n\t}\n\n\tbind_events() {\n\t\tthis.search_field.$input.on('input', (e) => {\n\t\t\tclearTimeout(this.last_search);\n\t\t\tthis.last_search = setTimeout(() => {\n\t\t\t\tconst search_term = e.target.value;\n\t\t\t\tthis.refresh_list(search_term, this.status_field.get_value());\n\t\t\t}, 300);\n\t\t});\n\t\tconst me = this;\n\t\tthis.$invoices_container.on('click', '.invoice-wrapper', function() {\n\t\t\tconst invoice_name = unescape($(this).attr('data-invoice-name'));\n\n\t\t\tme.events.open_invoice_data(invoice_name);\n\t\t});\n\t}\n\n\tmake_filter_section() {\n\t\tconst me = this;\n\t\tthis.search_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Search'),\n\t\t\t\tfieldtype: 'Data',\n\t\t\t\tplaceholder: __('Search by invoice id or customer name')\n\t\t\t},\n\t\t\tparent: this.$component.find('.search-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.status_field = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\tlabel: __('Invoice Status'),\n\t\t\t\tfieldtype: 'Select',\n\t\t\t\toptions: `Draft\\nPaid\\nConsolidated\\nReturn`,\n\t\t\t\tplaceholder: __('Filter by invoice status'),\n\t\t\t\tonchange: function() {\n\t\t\t\t\tif (me.$component.is(':visible')) me.refresh_list();\n\t\t\t\t}\n\t\t\t},\n\t\t\tparent: this.$component.find('.status-field'),\n\t\t\trender_input: true,\n\t\t});\n\t\tthis.search_field.toggle_label(false);\n\t\tthis.status_field.toggle_label(false);\n\t\tthis.status_field.set_value('Draft');\n\t}\n\n\trefresh_list() {\n\t\tfrappe.dom.freeze();\n\t\tthis.events.reset_summary();\n\t\tconst search_term = this.search_field.get_value();\n\t\tconst status = this.status_field.get_value();\n\n\t\tthis.$invoices_container.html('');\n\n\t\treturn frappe.call({\n\t\t\tmethod: \"erpnext.selling.page.point_of_sale.point_of_sale.get_past_order_list\",\n\t\t\tfreeze: true,\n\t\t\targs: { search_term, status },\n\t\t\tcallback: (response) => {\n\t\t\t\tfrappe.dom.unfreeze();\n\t\t\t\tresponse.message.forEach(invoice => {\n\t\t\t\t\tconst invoice_html = this.get_invoice_html(invoice);\n\t\t\t\t\tthis.$invoices_container.append(invoice_html);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tget_invoice_html(invoice) {\n\t\tconst posting_datetime = moment(invoice.posting_date+\" \"+invoice.posting_time).format(\"Do MMMM, h:mma\");\n\t\treturn (\n\t\t\t`<div class=\"invoice-wrapper\" data-invoice-name=\"${escape(invoice.name)}\">\n\t\t\t\t<div class=\"invoice-name-date\">\n\t\t\t\t\t<div class=\"invoice-name\">${invoice.name}</div>\n\t\t\t\t\t<div class=\"invoice-date\">\n\t\t\t\t\t\t<svg class=\"mr-2\" width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"1\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n\t\t\t\t\t\t\t<path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"/><circle cx=\"12\" cy=\"7\" r=\"4\"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t${frappe.ellipsis(invoice.customer, 20)}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"invoice-total-status\">\n\t\t\t\t\t<div class=\"invoice-total\">${format_currency(invoice.grand_total, invoice.currency, 0) || 0}</div>\n\t\t\t\t\t<div class=\"invoice-date\">${posting_datetime}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"seperator\"></div>`\n\t\t);\n\t}\n\n\ttoggle_component(show) {\n\t\tshow ? this.$component.css('display', 'flex') && this.refresh_list() : this.$component.css('display', 'none');\n\t}\n};\n","erpnext.PointOfSale.PastOrderSummary = class {\n\tconstructor({ wrapper, events }) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.events = events;\n\n\t\tthis.init_component();\n\t}\n\n\tinit_component() {\n\t\tthis.prepare_dom();\n\t\tthis.init_email_print_dialog();\n\t\tthis.bind_events();\n\t\tthis.attach_shortcuts();\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<section class=\"past-order-summary\">\n\t\t\t\t<div class=\"no-summary-placeholder\">\n\t\t\t\t\t${__('Select an invoice to load summary data')}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"invoice-summary-wrapper\">\n\t\t\t\t\t<div class=\"abs-container\">\n\t\t\t\t\t\t<div class=\"upper-section\"></div>\n\t\t\t\t\t\t<div class=\"label\">${__('Items')}</div>\n\t\t\t\t\t\t<div class=\"items-container summary-container\"></div>\n\t\t\t\t\t\t<div class=\"label\">${__('Totals')}</div>\n\t\t\t\t\t\t<div class=\"totals-container summary-container\"></div>\n\t\t\t\t\t\t<div class=\"label\">${__('Payments')}</div>\n\t\t\t\t\t\t<div class=\"payments-container summary-container\"></div>\n\t\t\t\t\t\t<div class=\"summary-btns\"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</section>`\n\t\t);\n\n\t\tthis.$component = this.wrapper.find('.past-order-summary');\n\t\tthis.$summary_wrapper = this.$component.find('.invoice-summary-wrapper');\n\t\tthis.$summary_container = this.$component.find('.abs-container');\n\t\tthis.$upper_section = this.$summary_container.find('.upper-section');\n\t\tthis.$items_container = this.$summary_container.find('.items-container');\n\t\tthis.$totals_container = this.$summary_container.find('.totals-container');\n\t\tthis.$payment_container = this.$summary_container.find('.payments-container');\n\t\tthis.$summary_btns = this.$summary_container.find('.summary-btns');\n\t}\n\n\tinit_email_print_dialog() {\n\t\tconst email_dialog = new frappe.ui.Dialog({\n\t\t\ttitle: 'Email Receipt',\n\t\t\tfields: [\n\t\t\t\t{fieldname: 'email_id', fieldtype: 'Data', options: 'Email', label: 'Email ID'},\n\t\t\t\t// {fieldname:'remarks', fieldtype:'Text', label:'Remarks (if any)'}\n\t\t\t],\n\t\t\tprimary_action: () => {\n\t\t\t\tthis.send_email();\n\t\t\t},\n\t\t\tprimary_action_label: __('Send'),\n\t\t});\n\t\tthis.email_dialog = email_dialog;\n\n\t\tconst print_dialog = new frappe.ui.Dialog({\n\t\t\ttitle: 'Print Receipt',\n\t\t\tfields: [\n\t\t\t\t{fieldname: 'print', fieldtype: 'Data', label: 'Print Preview'}\n\t\t\t],\n\t\t\tprimary_action: () => {\n\t\t\t\tthis.print_receipt();\n\t\t\t},\n\t\t\tprimary_action_label: __('Print'),\n\t\t});\n\t\tthis.print_dialog = print_dialog;\n\t}\n\n\tget_upper_section_html(doc) {\n\t\tconst { status } = doc;\n\t\tlet indicator_color = '';\n\n\t\tin_list(['Paid', 'Consolidated'], status) && (indicator_color = 'green');\n\t\tstatus === 'Draft' && (indicator_color = 'red');\n\t\tstatus === 'Return' && (indicator_color = 'grey');\n\n\t\treturn `<div class=\"left-section\">\n\t\t\t\t\t<div class=\"customer-name\">${doc.customer}</div>\n\t\t\t\t\t<div class=\"customer-email\">${this.customer_email}</div>\n\t\t\t\t\t<div class=\"cashier\">${__('Sold by')}: ${doc.owner}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"right-section\">\n\t\t\t\t\t<div class=\"paid-amount\">${format_currency(doc.paid_amount, doc.currency)}</div>\n\t\t\t\t\t<div class=\"invoice-name\">${doc.name}</div>\n\t\t\t\t\t<span class=\"indicator-pill whitespace-nowrap ${indicator_color}\"><span>${doc.status}</span></span>\n\t\t\t\t</div>`;\n\t}\n\n\tget_item_html(doc, item_data) {\n\t\treturn `<div class=\"item-row-wrapper\">\n\t\t\t\t\t<div class=\"item-name\">${item_data.item_name}</div>\n\t\t\t\t\t<div class=\"item-qty\">${item_data.qty || 0}</div>\n\t\t\t\t\t<div class=\"item-rate-disc\">${get_rate_discount_html()}</div>\n\t\t\t\t</div>`;\n\n\t\tfunction get_rate_discount_html() {\n\t\t\tif (item_data.rate && item_data.price_list_rate && item_data.rate !== item_data.price_list_rate) {\n\t\t\t\treturn `<span class=\"item-disc\">(${item_data.discount_percentage}% off)</span>\n\t\t\t\t\t\t<div class=\"item-rate\">${format_currency(item_data.rate, doc.currency)}</div>`;\n\t\t\t} else {\n\t\t\t\treturn `<div class=\"item-rate\">${format_currency(item_data.price_list_rate || item_data.rate, doc.currency)}</div>`;\n\t\t\t}\n\t\t}\n\t}\n\n\tget_discount_html(doc) {\n\t\tif (doc.discount_amount) {\n\t\t\treturn `<div class=\"summary-row-wrapper\">\n\t\t\t\t\t\t<div>Discount (${doc.additional_discount_percentage} %)</div>\n\t\t\t\t\t\t<div>${format_currency(doc.discount_amount, doc.currency)}</div>\n\t\t\t\t\t</div>`;\n\t\t} else {\n\t\t\treturn ``;\n\t\t}\n\t}\n\n\tget_net_total_html(doc) {\n\t\treturn `<div class=\"summary-row-wrapper\">\n\t\t\t\t\t<div>${__('Net Total')}</div>\n\t\t\t\t\t<div>${format_currency(doc.net_total, doc.currency)}</div>\n\t\t\t\t</div>`;\n\t}\n\n\tget_taxes_html(doc) {\n\t\tif (!doc.taxes.length) return '';\n\n\t\tlet taxes_html = doc.taxes.map(t => {\n\t\t\tconst description = /[0-9]+/.test(t.description) ? t.description : `${t.description} @ ${t.rate}%`;\n\t\t\treturn `\n\t\t\t\t<div class=\"tax-row\">\n\t\t\t\t\t<div class=\"tax-label\">${description}</div>\n\t\t\t\t\t<div class=\"tax-value\">${format_currency(t.tax_amount_after_discount_amount, doc.currency)}</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t}).join('');\n\n\t\treturn `<div class=\"taxes-wrapper\">${taxes_html}</div>`;\n\t}\n\n\tget_grand_total_html(doc) {\n\t\treturn `<div class=\"summary-row-wrapper grand-total\">\n\t\t\t\t\t<div>${__('Grand Total')}</div>\n\t\t\t\t\t<div>${format_currency(doc.grand_total, doc.currency)}</div>\n\t\t\t\t</div>`;\n\t}\n\n\tget_payment_html(doc, payment) {\n\t\treturn `<div class=\"summary-row-wrapper payments\">\n\t\t\t\t\t<div>${__(payment.mode_of_payment)}</div>\n\t\t\t\t\t<div>${format_currency(payment.amount, doc.currency)}</div>\n\t\t\t\t</div>`;\n\t}\n\n\tbind_events() {\n\t\tthis.$summary_container.on('click', '.return-btn', () => {\n\t\t\tthis.events.process_return(this.doc.name);\n\t\t\tthis.toggle_component(false);\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'flex');\n\t\t\tthis.$summary_wrapper.css('display', 'none');\n\t\t});\n\n\t\tthis.$summary_container.on('click', '.edit-btn', () => {\n\t\t\tthis.events.edit_order(this.doc.name);\n\t\t\tthis.toggle_component(false);\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'flex');\n\t\t\tthis.$summary_wrapper.css('display', 'none');\n\t\t});\n\n\t\tthis.$summary_container.on('click', '.delete-btn', () => {\n\t\t\tthis.events.delete_order(this.doc.name);\n\t\t\tthis.show_summary_placeholder();\n\t\t});\n\n\t\tthis.$summary_container.on('click', '.delete-btn', () => {\n\t\t\tthis.events.delete_order(this.doc.name);\n\t\t\tthis.show_summary_placeholder();\n\t\t\t// this.toggle_component(false);\n\t\t\t// this.$component.find('.no-summary-placeholder').removeClass('d-none');\n\t\t\t// this.$summary_wrapper.addClass('d-none');\n\t\t});\n\n\t\tthis.$summary_container.on('click', '.new-btn', () => {\n\t\t\tthis.events.new_order();\n\t\t\tthis.toggle_component(false);\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'flex');\n\t\t\tthis.$summary_wrapper.css('display', 'none');\n\t\t});\n\n\t\tthis.$summary_container.on('click', '.email-btn', () => {\n\t\t\tthis.email_dialog.fields_dict.email_id.set_value(this.customer_email);\n\t\t\tthis.email_dialog.show();\n\t\t});\n\n\t\tthis.$summary_container.on('click', '.print-btn', () => {\n\t\t\tthis.print_receipt();\n\t\t});\n\t}\n\n\tprint_receipt() {\n\t\tconst frm = this.events.get_frm();\n\t\tfrappe.utils.print(\n\t\t\tthis.doc.doctype,\n\t\t\tthis.doc.name,\n\t\t\tfrm.pos_print_format,\n\t\t\tthis.doc.letter_head,\n\t\t\tthis.doc.language || frappe.boot.lang\n\t\t);\n\t}\n\n\tattach_shortcuts() {\n\t\tconst ctrl_label = frappe.utils.is_mac() ? '⌘' : 'Ctrl';\n\t\tthis.$summary_container.find('.print-btn').attr(\"title\", `${ctrl_label}+P`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+p\",\n\t\t\taction: () => this.$summary_container.find('.print-btn').click(),\n\t\t\tcondition: () => this.$component.is(':visible') && this.$summary_container.find('.print-btn').is(\":visible\"),\n\t\t\tdescription: __(\"Print Receipt\"),\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t\tthis.$summary_container.find('.new-btn').attr(\"title\", `${ctrl_label}+Enter`);\n\t\tfrappe.ui.keys.on(\"ctrl+enter\", () => {\n\t\t\tconst summary_is_visible = this.$component.is(\":visible\");\n\t\t\tif (summary_is_visible && this.$summary_container.find('.new-btn').is(\":visible\")) {\n\t\t\t\tthis.$summary_container.find('.new-btn').click();\n\t\t\t}\n\t\t});\n\t\tthis.$summary_container.find('.edit-btn').attr(\"title\", `${ctrl_label}+E`);\n\t\tfrappe.ui.keys.add_shortcut({\n\t\t\tshortcut: \"ctrl+e\",\n\t\t\taction: () => this.$summary_container.find('.edit-btn').click(),\n\t\t\tcondition: () => this.$component.is(':visible') && this.$summary_container.find('.edit-btn').is(\":visible\"),\n\t\t\tdescription: __(\"Edit Receipt\"),\n\t\t\tpage: cur_page.page.page\n\t\t});\n\t}\n\n\tsend_email() {\n\t\tconst frm = this.events.get_frm();\n\t\tconst recipients = this.email_dialog.get_values().email_id;\n\t\tconst doc = this.doc || frm.doc;\n\t\tconst print_format = frm.pos_print_format;\n\n\t\tfrappe.call({\n\t\t\tmethod: \"frappe.core.doctype.communication.email.make\",\n\t\t\targs: {\n\t\t\t\trecipients: recipients,\n\t\t\t\tsubject: __(frm.meta.name) + ': ' + doc.name,\n\t\t\t\tdoctype: doc.doctype,\n\t\t\t\tname: doc.name,\n\t\t\t\tsend_email: 1,\n\t\t\t\tprint_format,\n\t\t\t\tsender_full_name: frappe.user.full_name(),\n\t\t\t\t_lang: doc.language\n\t\t\t},\n\t\t\tcallback: r => {\n\t\t\t\tif (!r.exc) {\n\t\t\t\t\tfrappe.utils.play_sound(\"email\");\n\t\t\t\t\tif (r.message[\"emails_not_sent_to\"]) {\n\t\t\t\t\t\tfrappe.msgprint(__(\n\t\t\t\t\t\t\t\"Email not sent to {0} (unsubscribed / disabled)\",\n\t\t\t\t\t\t\t[ frappe.utils.escape_html(r.message[\"emails_not_sent_to\"]) ]\n\t\t\t\t\t\t));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\tmessage: __('Email sent successfully.'),\n\t\t\t\t\t\t\tindicator: 'green'\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tthis.email_dialog.hide();\n\t\t\t\t} else {\n\t\t\t\t\tfrappe.msgprint(__(\"There were errors while sending email. Please try again.\"));\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tadd_summary_btns(map) {\n\t\tthis.$summary_btns.html('');\n\t\tmap.forEach(m => {\n\t\t\tif (m.condition) {\n\t\t\t\tm.visible_btns.forEach(b => {\n\t\t\t\t\tconst class_name = b.split(' ')[0].toLowerCase();\n\t\t\t\t\tconst btn = __(b);\n\t\t\t\t\tthis.$summary_btns.append(\n\t\t\t\t\t\t`<div class=\"summary-btn btn btn-default ${class_name}-btn\">${btn}</div>`\n\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t\tthis.$summary_btns.children().last().removeClass('mr-4');\n\t}\n\n\ttoggle_summary_placeholder(show) {\n\t\tif (show) {\n\t\t\tthis.$summary_wrapper.css('display', 'none');\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'flex');\n\t\t} else {\n\t\t\tthis.$summary_wrapper.css('display', 'flex');\n\t\t\tthis.$component.find('.no-summary-placeholder').css('display', 'none');\n\t\t}\n\t}\n\n\tget_condition_btn_map(after_submission) {\n\t\tif (after_submission)\n\t\t\treturn [{ condition: true, visible_btns: ['Print Receipt', 'Email Receipt', 'New Order'] }];\n\n\t\treturn [\n\t\t\t{ condition: this.doc.docstatus === 0, visible_btns: ['Edit Order', 'Delete Order'] },\n\t\t\t{ condition: !this.doc.is_return && this.doc.docstatus === 1, visible_btns: ['Print Receipt', 'Email Receipt', 'Return']},\n\t\t\t{ condition: this.doc.is_return && this.doc.docstatus === 1, visible_btns: ['Print Receipt', 'Email Receipt']}\n\t\t];\n\t}\n\n\tload_summary_of(doc, after_submission=false) {\n\t\tafter_submission ?\n\t\t\tthis.$component.css('grid-column', 'span 10 / span 10') :\n\t\t\tthis.$component.css('grid-column', 'span 6 / span 6');\n\n\t\tthis.toggle_summary_placeholder(false);\n\n\t\tthis.doc = doc;\n\n\t\tthis.attach_document_info(doc);\n\n\t\tthis.attach_items_info(doc);\n\n\t\tthis.attach_totals_info(doc);\n\n\t\tthis.attach_payments_info(doc);\n\n\t\tconst condition_btns_map = this.get_condition_btn_map(after_submission);\n\n\t\tthis.add_summary_btns(condition_btns_map);\n\t}\n\n\tattach_document_info(doc) {\n\t\tfrappe.db.get_value('Customer', this.doc.customer, 'email_id').then(({ message }) => {\n\t\t\tthis.customer_email = message.email_id || '';\n\t\t\tconst upper_section_dom = this.get_upper_section_html(doc);\n\t\t\tthis.$upper_section.html(upper_section_dom);\n\t\t});\n\t}\n\n\tattach_items_info(doc) {\n\t\tthis.$items_container.html('');\n\t\tdoc.items.forEach(item => {\n\t\t\tconst item_dom = this.get_item_html(doc, item);\n\t\t\tthis.$items_container.append(item_dom);\n\t\t\tthis.set_dynamic_rate_header_width();\n\t\t});\n\t}\n\n\tset_dynamic_rate_header_width() {\n\t\tconst rate_cols = Array.from(this.$items_container.find(\".item-rate-disc\"));\n\t\tthis.$items_container.find(\".item-rate-disc\").css(\"width\", \"\");\n\t\tlet max_width = rate_cols.reduce((max_width, elm) => {\n\t\t\tif ($(elm).width() > max_width)\n\t\t\t\tmax_width = $(elm).width();\n\t\t\treturn max_width;\n\t\t}, 0);\n\n\t\tmax_width += 1;\n\t\tif (max_width == 1) max_width = \"\";\n\n\t\tthis.$items_container.find(\".item-rate-disc\").css(\"width\", max_width);\n\t}\n\n\tattach_payments_info(doc) {\n\t\tthis.$payment_container.html('');\n\t\tdoc.payments.forEach(p => {\n\t\t\tif (p.amount) {\n\t\t\t\tconst payment_dom = this.get_payment_html(doc, p);\n\t\t\t\tthis.$payment_container.append(payment_dom);\n\t\t\t}\n\t\t});\n\t\tif (doc.redeem_loyalty_points && doc.loyalty_amount) {\n\t\t\tconst payment_dom = this.get_payment_html(doc, {\n\t\t\t\tmode_of_payment: 'Loyalty Points',\n\t\t\t\tamount: doc.loyalty_amount,\n\t\t\t});\n\t\t\tthis.$payment_container.append(payment_dom);\n\t\t}\n\t}\n\n\tattach_totals_info(doc) {\n\t\tthis.$totals_container.html('');\n\n\t\tconst net_total_dom = this.get_net_total_html(doc);\n\t\tconst taxes_dom = this.get_taxes_html(doc);\n\t\tconst discount_dom = this.get_discount_html(doc);\n\t\tconst grand_total_dom = this.get_grand_total_html(doc);\n\t\tthis.$totals_container.append(net_total_dom);\n\t\tthis.$totals_container.append(taxes_dom);\n\t\tthis.$totals_container.append(discount_dom);\n\t\tthis.$totals_container.append(grand_total_dom);\n\t}\n\n\ttoggle_component(show) {\n\t\tshow ? this.$component.css('display', 'flex') : this.$component.css('display', 'none');\n\t}\n};\n","erpnext.PointOfSale.Controller = class {\n\tconstructor(wrapper) {\n\t\tthis.wrapper = $(wrapper).find('.layout-main-section');\n\t\tthis.page = wrapper.page;\n\n\t\tthis.check_opening_entry();\n\t}\n\n\tfetch_opening_entry() {\n\t\treturn frappe.call(\"erpnext.selling.page.point_of_sale.point_of_sale.check_opening_entry\", { \"user\": frappe.session.user });\n\t}\n\n\tcheck_opening_entry() {\n\t\tthis.fetch_opening_entry().then((r) => {\n\t\t\tif (r.message.length) {\n\t\t\t\t// assuming only one opening voucher is available for the current user\n\t\t\t\tthis.prepare_app_defaults(r.message[0]);\n\t\t\t} else {\n\t\t\t\tthis.create_opening_voucher();\n\t\t\t}\n\t\t});\n\t}\n\n\tcreate_opening_voucher() {\n\t\tconst me = this;\n\t\tconst table_fields = [\n\t\t\t{\n\t\t\t\tfieldname: \"mode_of_payment\", fieldtype: \"Link\",\n\t\t\t\tin_list_view: 1, label: \"Mode of Payment\",\n\t\t\t\toptions: \"Mode of Payment\", reqd: 1\n\t\t\t},\n\t\t\t{\n\t\t\t\tfieldname: \"opening_amount\", fieldtype: \"Currency\",\n\t\t\t\tin_list_view: 1, label: \"Opening Amount\",\n\t\t\t\toptions: \"company:company_currency\",\n\t\t\t\tchange: function () {\n\t\t\t\t\tdialog.fields_dict.balance_details.df.data.some(d => {\n\t\t\t\t\t\tif (d.idx == this.doc.idx) {\n\t\t\t\t\t\t\td.opening_amount = this.value;\n\t\t\t\t\t\t\tdialog.fields_dict.balance_details.grid.refresh();\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t];\n\t\tconst fetch_pos_payment_methods = () => {\n\t\t\tconst pos_profile = dialog.fields_dict.pos_profile.get_value();\n\t\t\tif (!pos_profile) return;\n\t\t\tfrappe.db.get_doc(\"POS Profile\", pos_profile).then(({ payments }) => {\n\t\t\t\tdialog.fields_dict.balance_details.df.data = [];\n\t\t\t\tpayments.forEach(pay => {\n\t\t\t\t\tconst { mode_of_payment } = pay;\n\t\t\t\t\tdialog.fields_dict.balance_details.df.data.push({ mode_of_payment, opening_amount: '0' });\n\t\t\t\t});\n\t\t\t\tdialog.fields_dict.balance_details.grid.refresh();\n\t\t\t});\n\t\t}\n\t\tconst dialog = new frappe.ui.Dialog({\n\t\t\ttitle: __('Create POS Opening Entry'),\n\t\t\tstatic: true,\n\t\t\tfields: [\n\t\t\t\t{\n\t\t\t\t\tfieldtype: 'Link', label: __('Company'), default: frappe.defaults.get_default('company'),\n\t\t\t\t\toptions: 'Company', fieldname: 'company', reqd: 1\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tfieldtype: 'Link', label: __('POS Profile'),\n\t\t\t\t\toptions: 'POS Profile', fieldname: 'pos_profile', reqd: 1,\n\t\t\t\t\tget_query: () => pos_profile_query,\n\t\t\t\t\tonchange: () => fetch_pos_payment_methods()\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tfieldname: \"balance_details\",\n\t\t\t\t\tfieldtype: \"Table\",\n\t\t\t\t\tlabel: \"Opening Balance Details\",\n\t\t\t\t\tcannot_add_rows: false,\n\t\t\t\t\tin_place_edit: true,\n\t\t\t\t\treqd: 1,\n\t\t\t\t\tdata: [],\n\t\t\t\t\tfields: table_fields\n\t\t\t\t}\n\t\t\t],\n\t\t\tprimary_action: async function({ company, pos_profile, balance_details }) {\n\t\t\t\tif (!balance_details.length) {\n\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\tmessage: __(\"Please add Mode of payments and opening balance details.\"),\n\t\t\t\t\t\tindicator: 'red'\n\t\t\t\t\t})\n\t\t\t\t\treturn frappe.utils.play_sound(\"error\");\n\t\t\t\t}\n\n\t\t\t\t// filter balance details for empty rows\n\t\t\t\tbalance_details = balance_details.filter(d => d.mode_of_payment);\n\n\t\t\t\tconst method = \"erpnext.selling.page.point_of_sale.point_of_sale.create_opening_voucher\";\n\t\t\t\tconst res = await frappe.call({ method, args: { pos_profile, company, balance_details }, freeze:true });\n\t\t\t\t!res.exc && me.prepare_app_defaults(res.message);\n\t\t\t\tdialog.hide();\n\t\t\t},\n\t\t\tprimary_action_label: __('Submit')\n\t\t});\n\t\tdialog.show();\n\t\tconst pos_profile_query = {\n\t\t\tquery: 'erpnext.accounts.doctype.pos_profile.pos_profile.pos_profile_query',\n\t\t\tfilters: { company: dialog.fields_dict.company.get_value() }\n\t\t};\n\t}\n\n\tasync prepare_app_defaults(data) {\n\t\tthis.pos_opening = data.name;\n\t\tthis.company = data.company;\n\t\tthis.pos_profile = data.pos_profile;\n\t\tthis.pos_opening_time = data.period_start_date;\n\t\tthis.item_stock_map = {};\n\t\tthis.settings = {};\n\n\t\tfrappe.db.get_value('Stock Settings', undefined, 'allow_negative_stock').then(({ message }) => {\n\t\t\tthis.allow_negative_stock = flt(message.allow_negative_stock) || false;\n\t\t});\n\n\t\tfrappe.call({\n\t\t\tmethod: \"erpnext.selling.page.point_of_sale.point_of_sale.get_pos_profile_data\",\n\t\t\targs: { \"pos_profile\": this.pos_profile },\n\t\t\tcallback: (res) => {\n\t\t\t\tconst profile = res.message;\n\t\t\t\tObject.assign(this.settings, profile);\n\t\t\t\tthis.settings.customer_groups = profile.customer_groups.map(group => group.name);\n\t\t\t\tthis.make_app();\n\t\t\t}\n\t\t});\n\t}\n\n\tset_opening_entry_status() {\n\t\tthis.page.set_title_sub(\n\t\t\t`<span class=\"indicator orange\">\n\t\t\t\t<a class=\"text-muted\" href=\"#Form/POS%20Opening%20Entry/${this.pos_opening}\">\n\t\t\t\t\tOpened at ${moment(this.pos_opening_time).format(\"Do MMMM, h:mma\")}\n\t\t\t\t</a>\n\t\t\t</span>`);\n\t}\n\n\tmake_app() {\n\t\tthis.prepare_dom();\n\t\tthis.prepare_components();\n\t\tthis.prepare_menu();\n\t\tthis.make_new_invoice();\n\t}\n\n\tprepare_dom() {\n\t\tthis.wrapper.append(\n\t\t\t`<div class=\"point-of-sale-app\"></div>`\n\t\t);\n\n\t\tthis.$components_wrapper = this.wrapper.find('.point-of-sale-app');\n\t}\n\n\tprepare_components() {\n\t\tthis.init_item_selector();\n\t\tthis.init_item_details();\n\t\tthis.init_item_cart();\n\t\tthis.init_payments();\n\t\tthis.init_recent_order_list();\n\t\tthis.init_order_summary();\n\t}\n\n\tprepare_menu() {\n\t\tthis.page.clear_menu();\n\n\t\tthis.page.add_menu_item(__(\"Open Form View\"), this.open_form_view.bind(this), false, 'Ctrl+F');\n\n\t\tthis.page.add_menu_item(__(\"Toggle Recent Orders\"), this.toggle_recent_order.bind(this), false, 'Ctrl+O');\n\n\t\tthis.page.add_menu_item(__(\"Save as Draft\"), this.save_draft_invoice.bind(this), false, 'Ctrl+S');\n\n\t\tthis.page.add_menu_item(__('Close the POS'), this.close_pos.bind(this), false, 'Shift+Ctrl+C');\n\t}\n\n\topen_form_view() {\n\t\tfrappe.model.sync(this.frm.doc);\n\t\tfrappe.set_route(\"Form\", this.frm.doc.doctype, this.frm.doc.name);\n\t}\n\n\ttoggle_recent_order() {\n\t\tconst show = this.recent_order_list.$component.is(':hidden');\n\t\tthis.toggle_recent_order_list(show);\n\t}\n\n\tsave_draft_invoice() {\n\t\tif (!this.$components_wrapper.is(\":visible\")) return;\n\n\t\tif (this.frm.doc.items.length == 0) {\n\t\t\tfrappe.show_alert({\n\t\t\t\tmessage: __(\"You must add atleast one item to save it as draft.\"),\n\t\t\t\tindicator:'red'\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t\treturn;\n\t\t}\n\n\t\tthis.frm.save(undefined, undefined, undefined, () => {\n\t\t\tfrappe.show_alert({\n\t\t\t\tmessage: __(\"There was an error saving the document.\"),\n\t\t\t\tindicator: 'red'\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t}).then(() => {\n\t\t\tfrappe.run_serially([\n\t\t\t\t() => frappe.dom.freeze(),\n\t\t\t\t() => this.make_new_invoice(),\n\t\t\t\t() => frappe.dom.unfreeze(),\n\t\t\t]);\n\t\t});\n\t}\n\n\tclose_pos() {\n\t\tif (!this.$components_wrapper.is(\":visible\")) return;\n\n\t\tlet voucher = frappe.model.get_new_doc('POS Closing Entry');\n\t\tvoucher.pos_profile = this.frm.doc.pos_profile;\n\t\tvoucher.user = frappe.session.user;\n\t\tvoucher.company = this.frm.doc.company;\n\t\tvoucher.pos_opening_entry = this.pos_opening;\n\t\tvoucher.period_end_date = frappe.datetime.now_datetime();\n\t\tvoucher.posting_date = frappe.datetime.now_date();\n\t\tfrappe.set_route('Form', 'POS Closing Entry', voucher.name);\n\t}\n\n\tinit_item_selector() {\n\t\tthis.item_selector = new erpnext.PointOfSale.ItemSelector({\n\t\t\twrapper: this.$components_wrapper,\n\t\t\tpos_profile: this.pos_profile,\n\t\t\tsettings: this.settings,\n\t\t\tevents: {\n\t\t\t\titem_selected: args => this.on_cart_update(args),\n\n\t\t\t\tget_frm: () => this.frm || {}\n\t\t\t}\n\t\t})\n\t}\n\n\tinit_item_cart() {\n\t\tthis.cart = new erpnext.PointOfSale.ItemCart({\n\t\t\twrapper: this.$components_wrapper,\n\t\t\tsettings: this.settings,\n\t\t\tevents: {\n\t\t\t\tget_frm: () => this.frm,\n\n\t\t\t\tcart_item_clicked: (item) => {\n\t\t\t\t\tconst item_row = this.get_item_from_frm(item);\n\t\t\t\t\tthis.item_details.toggle_item_details_section(item_row);\n\t\t\t\t},\n\n\t\t\t\tnumpad_event: (value, action) => this.update_item_field(value, action),\n\n\t\t\t\tcheckout: () => this.save_and_checkout(),\n\n\t\t\t\tedit_cart: () => this.payment.edit_cart(),\n\n\t\t\t\tcustomer_details_updated: (details) => {\n\t\t\t\t\tthis.customer_details = details;\n\t\t\t\t\t// will add/remove LP payment method\n\t\t\t\t\tthis.payment.render_loyalty_points_payment_mode();\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t}\n\n\tinit_item_details() {\n\t\tthis.item_details = new erpnext.PointOfSale.ItemDetails({\n\t\t\twrapper: this.$components_wrapper,\n\t\t\tsettings: this.settings,\n\t\t\tevents: {\n\t\t\t\tget_frm: () => this.frm,\n\n\t\t\t\ttoggle_item_selector: (minimize) => {\n\t\t\t\t\tthis.item_selector.resize_selector(minimize);\n\t\t\t\t\tthis.cart.toggle_numpad(minimize);\n\t\t\t\t},\n\n\t\t\t\tform_updated: (item, field, value) => {\n\t\t\t\t\tconst item_row = frappe.model.get_doc(item.doctype, item.name);\n\t\t\t\t\tif (item_row && item_row[field] != value) {\n\t\t\t\t\t\tconst args = {\n\t\t\t\t\t\t\tfield,\n\t\t\t\t\t\t\tvalue,\n\t\t\t\t\t\t\titem: this.item_details.current_item\n\t\t\t\t\t\t};\n\t\t\t\t\t\treturn this.on_cart_update(args);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn Promise.resolve();\n\t\t\t\t},\n\n\t\t\t\thighlight_cart_item: (item) => {\n\t\t\t\t\tconst cart_item = this.cart.get_cart_item(item);\n\t\t\t\t\tthis.cart.toggle_item_highlight(cart_item);\n\t\t\t\t},\n\n\t\t\t\titem_field_focused: (fieldname) => {\n\t\t\t\t\tthis.cart.toggle_numpad_field_edit(fieldname);\n\t\t\t\t},\n\t\t\t\tset_value_in_current_cart_item: (selector, value) => {\n\t\t\t\t\tthis.cart.update_selector_value_in_cart_item(selector, value, this.item_details.current_item);\n\t\t\t\t},\n\t\t\t\tclone_new_batch_item_in_frm: (batch_serial_map, item) => {\n\t\t\t\t\t// called if serial nos are 'auto_selected' and if those serial nos belongs to multiple batches\n\t\t\t\t\t// for each unique batch new item row is added in the form & cart\n\t\t\t\t\tObject.keys(batch_serial_map).forEach(batch => {\n\t\t\t\t\t\tconst item_to_clone = this.frm.doc.items.find(i => i.name == item.name);\n\t\t\t\t\t\tconst new_row = this.frm.add_child(\"items\", { ...item_to_clone });\n\t\t\t\t\t\t// update new serialno and batch\n\t\t\t\t\t\tnew_row.batch_no = batch;\n\t\t\t\t\t\tnew_row.serial_no = batch_serial_map[batch].join(`\\n`);\n\t\t\t\t\t\tnew_row.qty = batch_serial_map[batch].length;\n\t\t\t\t\t\tthis.frm.doc.items.forEach(row => {\n\t\t\t\t\t\t\tif (item.item_code === row.item_code) {\n\t\t\t\t\t\t\t\tthis.update_cart_html(row);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t},\n\t\t\t\tremove_item_from_cart: () => this.remove_item_from_cart(),\n\t\t\t\tget_item_stock_map: () => this.item_stock_map,\n\t\t\t\tclose_item_details: () => {\n\t\t\t\t\tthis.item_details.toggle_item_details_section(null);\n\t\t\t\t\tthis.cart.prev_action = null;\n\t\t\t\t\tthis.cart.toggle_item_highlight();\n\t\t\t\t},\n\t\t\t\tget_available_stock: (item_code, warehouse) => this.get_available_stock(item_code, warehouse)\n\t\t\t}\n\t\t});\n\t}\n\n\tinit_payments() {\n\t\tthis.payment = new erpnext.PointOfSale.Payment({\n\t\t\twrapper: this.$components_wrapper,\n\t\t\tevents: {\n\t\t\t\tget_frm: () => this.frm || {},\n\n\t\t\t\tget_customer_details: () => this.customer_details || {},\n\n\t\t\t\ttoggle_other_sections: (show) => {\n\t\t\t\t\tif (show) {\n\t\t\t\t\t\tthis.item_details.$component.is(':visible') ? this.item_details.$component.css('display', 'none') : '';\n\t\t\t\t\t\tthis.item_selector.toggle_component(false);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.item_selector.toggle_component(true);\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\tsubmit_invoice: () => {\n\t\t\t\t\tthis.frm.savesubmit()\n\t\t\t\t\t\t.then((r) => {\n\t\t\t\t\t\t\tthis.toggle_components(false);\n\t\t\t\t\t\t\tthis.order_summary.toggle_component(true);\n\t\t\t\t\t\t\tthis.order_summary.load_summary_of(this.frm.doc, true);\n\t\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\t\tindicator: 'green',\n\t\t\t\t\t\t\t\tmessage: __('POS invoice {0} created succesfully', [r.doc.name])\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tinit_recent_order_list() {\n\t\tthis.recent_order_list = new erpnext.PointOfSale.PastOrderList({\n\t\t\twrapper: this.$components_wrapper,\n\t\t\tevents: {\n\t\t\t\topen_invoice_data: (name) => {\n\t\t\t\t\tfrappe.db.get_doc('POS Invoice', name).then((doc) => {\n\t\t\t\t\t\tthis.order_summary.load_summary_of(doc);\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\treset_summary: () => this.order_summary.toggle_summary_placeholder(true)\n\t\t\t}\n\t\t})\n\t}\n\n\tinit_order_summary() {\n\t\tthis.order_summary = new erpnext.PointOfSale.PastOrderSummary({\n\t\t\twrapper: this.$components_wrapper,\n\t\t\tevents: {\n\t\t\t\tget_frm: () => this.frm,\n\n\t\t\t\tprocess_return: (name) => {\n\t\t\t\t\tthis.recent_order_list.toggle_component(false);\n\t\t\t\t\tfrappe.db.get_doc('POS Invoice', name).then((doc) => {\n\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t() => this.make_return_invoice(doc),\n\t\t\t\t\t\t\t() => this.cart.load_invoice(),\n\t\t\t\t\t\t\t() => this.item_selector.toggle_component(true)\n\t\t\t\t\t\t]);\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tedit_order: (name) => {\n\t\t\t\t\tthis.recent_order_list.toggle_component(false);\n\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t() => this.frm.refresh(name),\n\t\t\t\t\t\t() => this.frm.call('reset_mode_of_payments'),\n\t\t\t\t\t\t() => this.cart.load_invoice(),\n\t\t\t\t\t\t() => this.item_selector.toggle_component(true)\n\t\t\t\t\t]);\n\t\t\t\t},\n\t\t\t\tdelete_order: (name) => {\n\t\t\t\t\tfrappe.model.delete_doc(this.frm.doc.doctype, name, () => {\n\t\t\t\t\t\tthis.recent_order_list.refresh_list();\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tnew_order: () => {\n\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t() => frappe.dom.freeze(),\n\t\t\t\t\t\t() => this.make_new_invoice(),\n\t\t\t\t\t\t() => this.item_selector.toggle_component(true),\n\t\t\t\t\t\t() => frappe.dom.unfreeze(),\n\t\t\t\t\t]);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t}\n\n\ttoggle_recent_order_list(show) {\n\t\tthis.toggle_components(!show);\n\t\tthis.recent_order_list.toggle_component(show);\n\t\tthis.order_summary.toggle_component(show);\n\t}\n\n\ttoggle_components(show) {\n\t\tthis.cart.toggle_component(show);\n\t\tthis.item_selector.toggle_component(show);\n\n\t\t// do not show item details or payment if recent order is toggled off\n\t\t!show ? (this.item_details.toggle_component(false) || this.payment.toggle_component(false)) : '';\n\t}\n\n\tmake_new_invoice() {\n\t\treturn frappe.run_serially([\n\t\t\t() => frappe.dom.freeze(),\n\t\t\t() => this.make_sales_invoice_frm(),\n\t\t\t() => this.set_pos_profile_data(),\n\t\t\t() => this.set_pos_profile_status(),\n\t\t\t() => this.cart.load_invoice(),\n\t\t\t() => frappe.dom.unfreeze()\n\t\t]);\n\t}\n\n\tmake_sales_invoice_frm() {\n\t\tconst doctype = 'POS Invoice';\n\t\treturn new Promise(resolve => {\n\t\t\tif (this.frm) {\n\t\t\t\tthis.frm = this.get_new_frm(this.frm);\n\t\t\t\tthis.frm.doc.items = [];\n\t\t\t\tthis.frm.doc.is_pos = 1\n\t\t\t\tresolve();\n\t\t\t} else {\n\t\t\t\tfrappe.model.with_doctype(doctype, () => {\n\t\t\t\t\tthis.frm = this.get_new_frm();\n\t\t\t\t\tthis.frm.doc.items = [];\n\t\t\t\t\tthis.frm.doc.is_pos = 1\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tget_new_frm(_frm) {\n\t\tconst doctype = 'POS Invoice';\n\t\tconst page = $('<div>');\n\t\tconst frm = _frm || new frappe.ui.form.Form(doctype, page, false);\n\t\tconst name = frappe.model.make_new_doc_and_get_name(doctype, true);\n\t\tfrm.refresh(name);\n\n\t\treturn frm;\n\t}\n\n\tasync make_return_invoice(doc) {\n\t\tfrappe.dom.freeze();\n\t\tthis.frm = this.get_new_frm(this.frm);\n\t\tthis.frm.doc.items = [];\n\t\treturn frappe.call({\n\t\t\tmethod: \"erpnext.accounts.doctype.pos_invoice.pos_invoice.make_sales_return\",\n\t\t\targs: {\n\t\t\t\t'source_name': doc.name,\n\t\t\t\t'target_doc': this.frm.doc\n\t\t\t},\n\t\t\tcallback: (r) => {\n\t\t\t\tfrappe.model.sync(r.message);\n\t\t\t\tfrappe.get_doc(r.message.doctype, r.message.name).__run_link_triggers = false;\n\t\t\t\tthis.set_pos_profile_data().then(() => {\n\t\t\t\t\tfrappe.dom.unfreeze();\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tset_pos_profile_data() {\n\t\tif (this.company && !this.frm.doc.company) this.frm.doc.company = this.company;\n\t\tif (this.pos_profile && !this.frm.doc.pos_profile) this.frm.doc.pos_profile = this.pos_profile;\n\t\tif (!this.frm.doc.company) return;\n\n\t\treturn this.frm.trigger(\"set_pos_data\");\n\t}\n\n\tset_pos_profile_status() {\n\t\tthis.page.set_indicator(this.pos_profile, \"blue\");\n\t}\n\n\tasync on_cart_update(args) {\n\t\tfrappe.dom.freeze();\n\t\tlet item_row = undefined;\n\t\ttry {\n\t\t\tlet { field, value, item } = args;\n\t\t\titem_row = this.get_item_from_frm(item);\n\t\t\tconst item_row_exists = !$.isEmptyObject(item_row);\n\n\t\t\tconst from_selector = field === 'qty' && value === \"+1\";\n\t\t\tif (from_selector)\n\t\t\t\tvalue = flt(item_row.qty) + flt(value);\n\n\t\t\tif (item_row_exists) {\n\t\t\t\tif (field === 'qty')\n\t\t\t\t\tvalue = flt(value);\n\n\t\t\t\tif (['qty', 'conversion_factor'].includes(field) && value > 0 && !this.allow_negative_stock) {\n\t\t\t\t\tconst qty_needed = field === 'qty' ? value * item_row.conversion_factor : item_row.qty * value;\n\t\t\t\t\tawait this.check_stock_availability(item_row, qty_needed, this.frm.doc.set_warehouse);\n\t\t\t\t}\n\n\t\t\t\tif (this.is_current_item_being_edited(item_row) || from_selector) {\n\t\t\t\t\tawait frappe.model.set_value(item_row.doctype, item_row.name, field, value);\n\t\t\t\t\tthis.update_cart_html(item_row);\n\t\t\t\t}\n\n\t\t\t} else {\n\t\t\t\tif (!this.frm.doc.customer)\n\t\t\t\t\treturn this.raise_customer_selection_alert();\n\n\t\t\t\tconst { item_code, batch_no, serial_no, rate } = item;\n\n\t\t\t\tif (!item_code)\n\t\t\t\t\treturn;\n\n\t\t\t\tconst new_item = { item_code, batch_no, rate, [field]: value };\n\n\t\t\t\tif (serial_no) {\n\t\t\t\t\tawait this.check_serial_no_availablilty(item_code, this.frm.doc.set_warehouse, serial_no);\n\t\t\t\t\tnew_item['serial_no'] = serial_no;\n\t\t\t\t}\n\n\t\t\t\tif (field === 'serial_no')\n\t\t\t\t\tnew_item['qty'] = value.split(`\\n`).length || 0;\n\n\t\t\t\titem_row = this.frm.add_child('items', new_item);\n\n\t\t\t\tif (field === 'qty' && value !== 0 && !this.allow_negative_stock)\n\t\t\t\t\tawait this.check_stock_availability(item_row, value, this.frm.doc.set_warehouse);\n\n\t\t\t\tawait this.trigger_new_item_events(item_row);\n\n\t\t\t\tthis.update_cart_html(item_row);\n\n\t\t\t\tif (this.item_details.$component.is(':visible'))\n\t\t\t\t\tthis.edit_item_details_of(item_row);\n\n\t\t\t\tif (this.check_serial_batch_selection_needed(item_row) && !this.item_details.$component.is(':visible'))\n\t\t\t\t\tthis.edit_item_details_of(item_row);\n\t\t\t}\n\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t} finally {\n\t\t\tfrappe.dom.unfreeze();\n\t\t\treturn item_row;\n\t\t}\n\t}\n\n\traise_customer_selection_alert() {\n\t\tfrappe.dom.unfreeze();\n\t\tfrappe.show_alert({\n\t\t\tmessage: __('You must select a customer before adding an item.'),\n\t\t\tindicator: 'orange'\n\t\t});\n\t\tfrappe.utils.play_sound(\"error\");\n\t}\n\n\tget_item_from_frm({ name, item_code, batch_no, uom, rate }) {\n\t\tlet item_row = null;\n\t\tif (name) {\n\t\t\titem_row = this.frm.doc.items.find(i => i.name == name);\n\t\t} else {\n\t\t\t// if item is clicked twice from item selector\n\t\t\t// then \"item_code, batch_no, uom, rate\" will help in getting the exact item\n\t\t\t// to increase the qty by one\n\t\t\tconst has_batch_no = batch_no;\n\t\t\titem_row = this.frm.doc.items.find(\n\t\t\t\ti => i.item_code === item_code\n\t\t\t\t\t&& (!has_batch_no || (has_batch_no && i.batch_no === batch_no))\n\t\t\t\t\t&& (i.uom === uom)\n\t\t\t\t\t&& (i.rate == rate)\n\t\t\t);\n\t\t}\n\n\t\treturn item_row || {};\n\t}\n\n\tedit_item_details_of(item_row) {\n\t\tthis.item_details.toggle_item_details_section(item_row);\n\t}\n\n\tis_current_item_being_edited(item_row) {\n\t\treturn item_row.name == this.item_details.current_item.name;\n\t}\n\n\tupdate_cart_html(item_row, remove_item) {\n\t\tthis.cart.update_item_html(item_row, remove_item);\n\t\tthis.cart.update_totals_section(this.frm);\n\t}\n\n\tcheck_serial_batch_selection_needed(item_row) {\n\t\t// right now item details is shown for every type of item.\n\t\t// if item details is not shown for every item then this fn will be needed\n\t\tconst serialized = item_row.has_serial_no;\n\t\tconst batched = item_row.has_batch_no;\n\t\tconst no_serial_selected = !item_row.serial_no;\n\t\tconst no_batch_selected = !item_row.batch_no;\n\n\t\tif ((serialized && no_serial_selected) || (batched && no_batch_selected) ||\n\t\t\t(serialized && batched && (no_batch_selected || no_serial_selected))) {\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tasync trigger_new_item_events(item_row) {\n\t\tawait this.frm.script_manager.trigger('item_code', item_row.doctype, item_row.name);\n\t\tawait this.frm.script_manager.trigger('qty', item_row.doctype, item_row.name);\n\t}\n\n\tasync check_stock_availability(item_row, qty_needed, warehouse) {\n\t\tconst resp = (await this.get_available_stock(item_row.item_code, warehouse)).message;\n\t\tconst available_qty = resp[0];\n\t\tconst is_stock_item = resp[1];\n\n\t\tfrappe.dom.unfreeze();\n\t\tconst bold_item_code = item_row.item_code.bold();\n\t\tconst bold_warehouse = warehouse.bold();\n\t\tconst bold_available_qty = available_qty.toString().bold()\n\t\tif (!(available_qty > 0)) {\n\t\t\tif (is_stock_item) {\n\t\t\t\tfrappe.model.clear_doc(item_row.doctype, item_row.name);\n\t\t\t\tfrappe.throw({\n\t\t\t\t\ttitle: __(\"Not Available\"),\n\t\t\t\t\tmessage: __('Item Code: {0} is not available under warehouse {1}.', [bold_item_code, bold_warehouse])\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\treturn;\n\t\t\t}\n\t\t} else if (available_qty < qty_needed) {\n\t\t\tfrappe.throw({\n\t\t\t\tmessage: __('Stock quantity not enough for Item Code: {0} under warehouse {1}. Available quantity {2}.', [bold_item_code, bold_warehouse, bold_available_qty]),\n\t\t\t\tindicator: 'orange'\n\t\t\t});\n\t\t\tfrappe.utils.play_sound(\"error\");\n\t\t}\n\t\tfrappe.dom.freeze();\n\t}\n\n\tasync check_serial_no_availablilty(item_code, warehouse, serial_no) {\n\t\tconst method = \"erpnext.stock.doctype.serial_no.serial_no.get_pos_reserved_serial_nos\";\n\t\tconst args = {filters: { item_code, warehouse }}\n\t\tconst res = await frappe.call({ method, args });\n\n\t\tif (res.message.includes(serial_no)) {\n\t\t\tfrappe.throw({\n\t\t\t\ttitle: __(\"Not Available\"),\n\t\t\t\tmessage: __('Serial No: {0} has already been transacted into another POS Invoice.', [serial_no.bold()])\n\t\t\t});\n\t\t}\n\t}\n\n\tget_available_stock(item_code, warehouse) {\n\t\tconst me = this;\n\t\treturn frappe.call({\n\t\t\tmethod: \"erpnext.accounts.doctype.pos_invoice.pos_invoice.get_stock_availability\",\n\t\t\targs: {\n\t\t\t\t'item_code': item_code,\n\t\t\t\t'warehouse': warehouse,\n\t\t\t},\n\t\t\tcallback(res) {\n\t\t\t\tif (!me.item_stock_map[item_code])\n\t\t\t\t\tme.item_stock_map[item_code] = {};\n\t\t\t\tme.item_stock_map[item_code][warehouse] = res.message[0];\n\t\t\t}\n\t\t});\n\t}\n\n\tupdate_item_field(value, field_or_action) {\n\t\tif (field_or_action === 'checkout') {\n\t\t\tthis.item_details.toggle_item_details_section(null);\n\t\t} else if (field_or_action === 'remove') {\n\t\t\tthis.remove_item_from_cart();\n\t\t} else {\n\t\t\tconst field_control = this.item_details[`${field_or_action}_control`];\n\t\t\tif (!field_control) return;\n\t\t\tfield_control.set_focus();\n\t\t\tvalue != \"\" && field_control.set_value(value);\n\t\t}\n\t}\n\n\tremove_item_from_cart() {\n\t\tfrappe.dom.freeze();\n\t\tconst { doctype, name, current_item } = this.item_details;\n\n\t\treturn frappe.model.set_value(doctype, name, 'qty', 0)\n\t\t\t.then(() => {\n\t\t\t\tfrappe.model.clear_doc(doctype, name);\n\t\t\t\tthis.update_cart_html(current_item, true);\n\t\t\t\tthis.item_details.toggle_item_details_section(null);\n\t\t\t\tfrappe.dom.unfreeze();\n\t\t\t})\n\t\t\t.catch(e => console.log(e));\n\t}\n\n\tasync save_and_checkout() {\n\t\tif (this.frm.is_dirty()) {\n\t\t\tlet save_error = false;\n\t\t\tawait this.frm.save(null, null, null, () => save_error = true);\n\t\t\t// only move to payment section if save is successful\n\t\t\t!save_error && this.payment.checkout();\n\t\t\t// show checkout button on error\n\t\t\tsave_error && setTimeout(() => {\n\t\t\t\tthis.cart.toggle_checkout_btn(true);\n\t\t\t}, 300); // wait for save to finish\n\t\t} else {\n\t\t\tthis.payment.checkout();\n\t\t}\n\t}\n};\n"],"names":["erpnext","PointOfSale","ItemSelector","[object Object]","ref","this","wrapper","events","pos_profile","hide_images","settings","auto_add_item","auto_add_item_to_cart","inti_component","prepare_dom","make_search_bar","load_items_data","bind_events","attach_shortcuts","append","__","$component","find","$items_container","item_group","const","res","frappe","db","get_value","lft","is_group","parent_item_group","message","name","price_list","selling_price_list","get_items","then","render_item_list","items","doc","get_frm","call","method","freeze","args","start","page_length","search_term","html","forEach","item","item_html","get_item_html","indicator_color","me","precision","flt","price_list_rate","qty_to_display","actual_qty","is_stock_item","Math","round","toFixed","escape","item_code","serial_no","batch_no","stock_uom","item_image","get_abbr","item_name","ellipsis","format_currency","currency","$img","item_abbr","$","attr","parent","replaceWith","search_field","ui","form","make_control","df","label","fieldtype","placeholder","render_input","item_group_field","options","onchange","value","filter_items","get_query","query","filters","toggle_label","attach_clear_btn","$wrapper","utils","icon","$clear_search_btn","on","set_search_value","set_focus","$input","val","trigger","window","onScan","decodeKeyEvent","oEvent","iCode","_getNormalizedKeyNum","undefined","key","sDecoded","String","fromCharCode","shiftKey","toLowerCase","toUpperCase","attachTo","document","sScancode","is","barcode_scanned","$item","unescape","uom","rate","item_selected","field","e","clearTimeout","last_search","setTimeout","target","toggle","Boolean","ctrl_label","is_mac","keys","add_shortcut","shortcut","action","condition","description","ignore_inputs","page","cur_page","length","click","play_sound","show_alert","indicator","search_index","add_filtered_item_to_cart","barcode","minimize","css","show","ItemCart","customer_info","allowed_customer_groups","customer_groups","allow_rate_change","allow_discount_change","init_component","init_child_components","init_customer_selector","init_cart_components","$customer_section","make_customer_selector","set_value","customer_field","$cart_container","make_cart_totals_section","make_cart_items_section","make_cart_numpad","$cart_header","$cart_items_wrapper","make_no_items_placeholder","$totals_section","get_discount_icon","$add_discount_elem","$numpad_section","number_pad","NumberPad","numpad_event","on_numpad_event","bind","cols","css_classes","fieldnames_map","Quantity","Discount","prepend","reset_customer_selector","toggle_customer_info","closest","$cart_item","toggle_item_highlight","item_row_name","cart_item_clicked","numpad_value","async","indexOf","checkout","toggle_checkout_btn","removeClass","edit_cart","can_edit_discount","discount_field","show_discount_control","frm","update_totals_section","let","btn","shortcut_key","scrub","fieldname","fieldnames","shortcut_label","split","map","to_title_case","join","replace","item_is_selected","row","item_cart_visible","checkout_btn_invisible","item_is_highlighted","not","allowed_customer_group","customer_group","dom","model","doctype","script_manager","run_serially","fetch_customer_details","customer_details_updated","update_customer_section","unfreeze","customer","Promise","resolve","loyalty_program","silent","callback","r","exc","Object","loyalty_points","conversion_factor","padding","border","discount","additional_discount_percentage","input_class","hide_discount_control","bold","get_customer_image","email_id","mobile_no","image","render_net_total","net_total","render_total_item_qty","grand_total","cint","sys_defaults","disable_rounded_total","rounded_total","render_grand_total","render_taxes","taxes","total_item_qty","qty","taxes_html","t","tax_amount_after_discount_amount","test","item_selector","i","remove_item","get_cart_item","next","remove","item_row","get_item_from_frm","render_cart_item","no_of_cart_items","highlight_checkout_btn","update_empty_cart_section","item_data","$item_to_update","text","error","amount","rate_cols","Array","from","max_width","reduce","elm","width","set_dynamic_rate_header_width","selector","show_checkout","background-color","$no_item_element","$btn","current_action","action_is_field_edit","includes","action_is_allowed","action_is_pressed_twice","prev_action","first_click_event","field_to_edit_changed","slice","highlight_numpad_btn","curr_action","curr_action_is_highlighted","hasClass","curr_action_is_action","addClass","reset_numpad","height","padding-top","render_customer_fields","fetch_customer_transactions","$customer_form","dfs","read_only","handle_customer_field_change","current_value","current_customer","get_list","docstatus","fields","limit","transaction_container","elapsed_time","moment","posting_date","posting_time","fromNow","invoice","posting_datetime","format","Paid","Draft","Return","Consolidated","status","off","update_item_html","attach_refresh_field_event","toggle_component","ItemDetails","current_item","$item_name","$item_description","$item_price","$item_image","$form_container","$dicount_section","current_item_changed","compare_with_current_item","hide_item_details","validate_serial_batch_item","toggle_item_selector","item_meta","get_meta","render_dom","render_discount_dom","render_form","highlight_cart_item","serialized","has_serial_no","batched","has_batch_no","no_serial_selected","no_batch_selected","remove_item_from_cart","substr","discount_percentage","fields_to_display","get_form_fields","idx","field_meta","form_updated","make_auto_serial_selection_btn","bind_custom_control_change_event","push","rate_control","get_doc","refresh","discount_percentage_control","warehouse_control","reqd","item_stock_map","get_item_stock_map","available_qty","get_available_stock","bold_item_code","bold_warehouse","throw","actual_qty_control","company","serial_no_control","auto_update_batch_no","batch_no_control","warehouse","uom_control","conversion_factor_control","field_control","cur_pos","update_cart_html","selected_serial_nos","filter","s","batch_serial_map","acc","batch_serial_nos","serial_nos_belongs_to_other_batch","qty_control","clone_new_batch_item_in_frm","bind_auto_serial_fetch_event","bind_fields_to_numpad_fields","close_item_details","last_field_focused","item_field_focused","expiry_date","numbers","batch_nos","for_doctype","data","auto_fetched_serial_numbers","records_length","msgprint","a","a2","number","j","Payment","initialize_numpad","$payment_modes","$totals","$numpad","$invoice_fields_section","invoice_fields","$invoice_fields","df_events","has_handlers","docname","on_numpad_clicked","button_value","selected_mode","get","focus","mode_clicked","scrollLeft","offset","left","animate","mode","auto_set_remaining_amount","contact","contact_mobile","request_button","request_for_payment_field","coupon_code","applying_pos_coupon_code","ignore_pricing_rule","save","setup_listener_for_payments","paid_amount","submit_invoice","is_cash_shortcuts_invisible","attach_cash_shortcuts","render_payment_mode_dom","formatted_currency","loyalty_amount","cdt","cdn","default_mop","locals","mode_of_payment","realtime","title","success","cur_frm","reload_doc","failure_message","remaining_amount","payment_is_visible","active_mode","mode_of_payments","m","mode_index","next_mode_index","next_mode_to_be_clicked","make_invoice_fields_control","focus_on_default_mop","toggle_other_sections","render_payment_section","$remarks","payments","p","payment_type","type","render_loyalty_points_payment_mode","default","shortcuts","get_cash_shortcuts","shortcuts_html","after","steps","digits","x","finalArr","nearest_x","ceil","get_nearest","get_customer_details","max_redeemable_amount","children","redeem_loyalty_points","parseInt","remaining","change","change_amount","PastOrderList","make_filter_section","$invoices_container","refresh_list","status_field","invoice_name","open_invoice_data","reset_summary","response","invoice_html","get_invoice_html","PastOrderSummary","init_email_print_dialog","$summary_wrapper","$summary_container","$upper_section","$totals_container","$payment_container","$summary_btns","email_dialog","Dialog","primary_action","send_email","primary_action_label","print_dialog","print_receipt","in_list","discount_amount","payment","process_return","edit_order","delete_order","show_summary_placeholder","new_order","fields_dict","customer_email","print","pos_print_format","letter_head","language","boot","lang","recipients","get_values","print_format","subject","meta","sender_full_name","user","full_name","_lang","escape_html","hide","visible_btns","b","class_name","last","after_submission","is_return","toggle_summary_placeholder","attach_document_info","attach_items_info","attach_totals_info","attach_payments_info","condition_btns_map","get_condition_btn_map","add_summary_btns","upper_section_dom","get_upper_section_html","item_dom","payment_dom","get_payment_html","net_total_dom","get_net_total_html","taxes_dom","get_taxes_html","discount_dom","get_discount_html","grand_total_dom","get_grand_total_html","Controller","check_opening_entry","session","fetch_opening_entry","prepare_app_defaults","create_opening_voucher","table_fields","in_list_view","dialog","balance_details","some","d","opening_amount","grid","static","defaults","get_default","pos_profile_query","pay","cannot_add_rows","in_place_edit","pos_opening","pos_opening_time","period_start_date","allow_negative_stock","profile","assign","group","make_app","set_title_sub","prepare_components","prepare_menu","make_new_invoice","$components_wrapper","init_item_selector","init_item_details","init_item_cart","init_payments","init_recent_order_list","init_order_summary","clear_menu","add_menu_item","open_form_view","toggle_recent_order","save_draft_invoice","close_pos","sync","set_route","recent_order_list","toggle_recent_order_list","voucher","get_new_doc","pos_opening_entry","period_end_date","datetime","now_datetime","now_date","on_cart_update","cart","item_details","toggle_item_details_section","update_item_field","save_and_checkout","details","customer_details","resize_selector","toggle_numpad","cart_item","toggle_numpad_field_edit","set_value_in_current_cart_item","update_selector_value_in_cart_item","batch","item_to_clone","new_row","add_child","savesubmit","toggle_components","order_summary","load_summary_of","make_return_invoice","load_invoice","delete_doc","make_sales_invoice_frm","set_pos_profile_data","set_pos_profile_status","get_new_frm","is_pos","with_doctype","_frm","Form","make_new_doc_and_get_name","source_name","target_doc","__run_link_triggers","set_indicator","item_row_exists","isEmptyObject","from_selector","qty_needed","check_stock_availability","set_warehouse","is_current_item_being_edited","raise_customer_selection_alert","new_item","check_serial_no_availablilty","trigger_new_item_events","edit_item_details_of","check_serial_batch_selection_needed","console","log","resp","bold_available_qty","toString","clear_doc","field_or_action","catch","is_dirty","save_error"],"mappings":"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"}