!function(e){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,erpnext.HierarchyChart=class{constructor(e,t,a){this.page=t.page,this.method=a,this.doctype=e,this.setup_page_style(),this.page.main.addClass("frappe-card"),this.nodes={},this.setup_node_class()}setup_page_style(){this.page.main.css({"min-height":"300px","max-height":"600px",overflow:"auto",position:"relative"})}setup_node_class(){var e=this;this.Node=class{constructor(t){t.id,t.parent,t.parent_id,t.image,t.name,t.title,t.expandable,t.connections,t.is_root;$.extend(this,arguments[0]),this.expanded=0,e.nodes[this.id]=this,e.make_node_element(this),e.all_nodes_expanded||e.setup_node_click_action(this),e.setup_edit_node_action(this)}}}make_node_element(e){var t=frappe.render_template("node_card",{id:e.id,name:e.name,title:e.title,image:e.image,parent:e.parent_id,connections:e.connections,is_mobile:!1});e.parent.append(t),e.$link=$('[id="'+e.id+'"]')}show(){if(this.setup_actions(),!$('[data-fieldname="company"]').length){var e=this,t=this.page.add_field({fieldtype:"Link",options:"Company",fieldname:"company",placeholder:__("Select Company"),default:frappe.defaults.get_default("company"),only_select:!0,reqd:1,change:function(){e.company=void 0,$("#hierarchy-chart-wrapper").remove(),t.get_value()?(e.company=t.get_value(),e.make_svg_markers(),e.setup_hierarchy(),e.render_root_nodes(),e.all_nodes_expanded=!1):frappe.throw(__("Please select a company first."))}});t.refresh(),$('[data-fieldname="company"]').trigger("change"),$('[data-fieldname="company"] .link-field').css("z-index",2)}}setup_actions(){var e=this;this.page.clear_inner_toolbar(),this.page.add_inner_button(__("Export"),function(){e.export_chart()}),this.page.add_inner_button(__("Expand All"),function(){e.load_children(e.root_node,!0),e.all_nodes_expanded=!0,e.page.remove_inner_button(__("Expand All")),e.page.add_inner_button(__("Collapse All"),function(){e.setup_hierarchy(),e.render_root_nodes(),e.all_nodes_expanded=!1,e.page.remove_inner_button(__("Collapse All")),e.setup_actions()})})}export_chart(){frappe.dom.freeze(__("Exporting...")),this.page.main.css({"min-height":"","max-height":"",overflow:"visible",position:"fixed",left:"0",top:"0"}),$(".node-card").addClass("exported"),e(document.querySelector("#hierarchy-chart-wrapper"),{scrollY:-window.scrollY,scrollX:0}).then(function(e){var t=e.toDataURL("image/png"),a=document.createElement("a");a.href=t,a.download="hierarchy_chart",a.click()}).finally(function(){frappe.dom.unfreeze()}),this.setup_page_style(),$(".node-card").removeClass("exported")}setup_hierarchy(){this.$hierarchy&&this.$hierarchy.remove(),$("#connectors").empty(),this.$hierarchy=$('<ul class="hierarchy">\n\t\t\t\t<li class="root-level level">\n\t\t\t\t\t<ul class="node-children"></ul>\n\t\t\t\t</li>\n\t\t\t</ul>'),this.page.main.find("#hierarchy-chart").empty().append(this.$hierarchy),this.nodes={}}make_svg_markers(){$("#hierarchy-chart-wrapper").remove(),this.page.main.append('\n\t\t\t<div id="hierarchy-chart-wrapper">\n\t\t\t\t<svg id="arrows" width="100%" height="100%">\n\t\t\t\t\t<defs>\n\t\t\t\t\t\t<marker id="arrowhead-active" viewBox="0 0 10 10" refX="3" refY="5" markerWidth="6" markerHeight="6" orient="auto" fill="var(--blue-500)">\n\t\t\t\t\t\t\t<path d="M 0 0 L 10 5 L 0 10 z"></path>\n\t\t\t\t\t\t</marker>\n\t\t\t\t\t\t<marker id="arrowhead-collapsed" viewBox="0 0 10 10" refX="3" refY="5" markerWidth="6" markerHeight="6" orient="auto" fill="var(--blue-300)">\n\t\t\t\t\t\t\t<path d="M 0 0 L 10 5 L 0 10 z"></path>\n\t\t\t\t\t\t</marker>\n\n\t\t\t\t\t\t<marker id="arrowstart-active" viewBox="0 0 10 10" refX="3" refY="5" markerWidth="8" markerHeight="8" orient="auto" fill="var(--blue-500)">\n\t\t\t\t\t\t\t<circle cx="4" cy="4" r="3.5" fill="white" stroke="var(--blue-500)"/>\n\t\t\t\t\t\t</marker>\n\t\t\t\t\t\t<marker id="arrowstart-collapsed" viewBox="0 0 10 10" refX="3" refY="5" markerWidth="8" markerHeight="8" orient="auto" fill="var(--blue-300)">\n\t\t\t\t\t\t\t<circle cx="4" cy="4" r="3.5" fill="white" stroke="var(--blue-300)"/>\n\t\t\t\t\t\t</marker>\n\t\t\t\t\t</defs>\n\t\t\t\t\t<g id="connectors" fill="none">\n\t\t\t\t\t</g>\n\t\t\t\t</svg>\n\t\t\t\t<div id="hierarchy-chart">\n\t\t\t\t</div>\n\t\t\t</div>')}render_root_nodes(e){void 0===e&&(e=!1);var t=this;return frappe.call({method:t.method,args:{company:t.company}}).then(function(a){if(a.message.length){var n=void 0,i=void 0;$.each(a.message,function(e,a){$('[id="'+a.id+'"]').length||(i=new t.Node({id:a.id,parent:$('<li class="child-node"></li>').appendTo(t.$hierarchy.find(".node-children")),parent_id:void 0,image:a.image,name:a.name,title:a.title,expandable:!0,connections:a.connections,is_root:!0}),!n&&a.connections&&(n=i))}),t.root_node=n,e||t.expand_node(n)}})}expand_node(e){var t=this.selected_node&&this.selected_node.parent_id===e.parent_id;if(this.set_selected_node(e),this.show_active_path(e),this.collapse_previous_level_nodes(e),!t){this.refresh_connectors(e.parent_id);var a=$('[id="'+e.parent_id+'"]').attr("data-parent");this.refresh_connectors(a)}if(e.expandable&&!e.expanded)return this.load_children(e)}collapse_node(){this.selected_node.expandable&&(this.selected_node.$children.hide(),$('path[data-parent="'+this.selected_node.id+'"]').hide(),this.selected_node.expanded=!1)}show_active_path(e){$('[id="'+e.parent_id+'"]').addClass("active-path")}load_children(e,t){var a=this;void 0===t&&(t=!1),t?frappe.run_serially([function(){return frappe.dom.freeze()},function(){return a.setup_hierarchy()},function(){return a.render_root_nodes(!0)},function(){return a.get_all_nodes()},function(e){return a.render_children_of_all_nodes(e)},function(){return frappe.dom.unfreeze()}]):frappe.run_serially([function(){return a.get_child_nodes(e.id)},function(t){return a.render_child_nodes(e,t)}])}get_child_nodes(e){var t=this;return new Promise(function(a){frappe.call({method:t.method,args:{parent:e,company:t.company}}).then(function(e){return a(e.message)})})}render_child_nodes(e,t){var a=this;this.$hierarchy.find(".level:last").index()===$('[id="'+e.id+'"]').parent().parent().parent().index()&&this.$hierarchy.append('\n\t\t\t\t<li class="level"></li>\n\t\t\t'),e.$children||(e.$children=$('<ul class="node-children"></ul>').hide().appendTo(this.$hierarchy.find(".level:last")),e.$children.empty(),t&&$.each(t,function(t,n){$('[id="'+n.id+'"]').length||(a.add_node(e,n),setTimeout(function(){a.add_connector(e.id,n.id)},250))})),e.$children.show(),$('path[data-parent="'+e.id+'"]').show(),e.expanded=!0}get_all_nodes(){var e=this;return new Promise(function(t){frappe.call({method:"erpnext.utilities.hierarchy_chart.get_all_nodes",args:{method:e.method,company:e.company},callback:function(e){t(e.message)}})})}render_children_of_all_nodes(e){for(var t=void 0,a=void 0;e.length;)t=e.shift(),(a=this.nodes[t.parent])?this.render_child_nodes_for_expanded_view(a,t.data):e.length&&e.push(t)}render_child_nodes_for_expanded_view(e,t){var a=this;e.$children=$('<ul class="node-children"></ul>');var n=this.$hierarchy.find(".level:last").index(),i=$('[id="'+e.id+'"]').parent().parent().parent().index();n===i?(this.$hierarchy.append('\n\t\t\t\t<li class="level"></li>\n\t\t\t'),e.$children.appendTo(this.$hierarchy.find(".level:last"))):e.$children.appendTo(this.$hierarchy.find(".level:eq("+(i+1)+")")),e.$children.hide().empty(),t&&$.each(t,function(t,n){a.add_node(e,n),setTimeout(function(){a.add_connector(e.id,n.id)},250)}),e.$children.show(),$('path[data-parent="'+e.id+'"]').show(),e.expanded=!0}add_node(e,t){return new this.Node({id:t.id,parent:$('<li class="child-node"></li>').appendTo(e.$children),parent_id:e.id,image:t.image,name:t.name,title:t.title,expandable:t.expandable,connections:t.connections,children:void 0})}add_connector(e,t){var a=document.getElementById(""+e),n=document.getElementById(""+t),i=document.createElementNS("http://www.w3.org/2000/svg","path"),r={x:a.offsetLeft+a.offsetWidth,y:a.offsetTop+a.offsetHeight/2},d={x:n.offsetLeft-5,y:n.offsetTop+n.offsetHeight/2},o=this.get_connector(r,d);i.setAttribute("d",o),this.set_path_attributes(i,e,t),document.getElementById("connectors").appendChild(i)}get_connector(e,t){if(e.y===t.y)return"M"+e.x+","+e.y+" L"+t.x+","+t.y;var a="",n="",i=0;return e.y>t.y?(a="a10,10 1 0 0 10,-10 ",n="a10,10 0 0 1 10,-10 ",i=10):(a="a10,10 0 0 1 10,10 ",n="a10,10 1 0 0 10,10 ",i=-10),"M"+e.x+","+e.y+" L"+(e.x+40)+","+e.y+" "+a+"L"+(e.x+50)+","+(t.y+i)+" "+n+"L"+t.x+","+t.y}set_path_attributes(e,t,a){e.setAttribute("data-parent",t),e.setAttribute("data-child",a),$('[id="'+t+'"]').hasClass("active")?(e.setAttribute("class","active-connector"),e.setAttribute("marker-start","url(#arrowstart-active)"),e.setAttribute("marker-end","url(#arrowhead-active)")):(e.setAttribute("class","collapsed-connector"),e.setAttribute("marker-start","url(#arrowstart-collapsed)"),e.setAttribute("marker-end","url(#arrowhead-collapsed)"))}set_selected_node(e){this.selected_node&&this.selected_node.$link.removeClass("active"),this.selected_node=e,e.$link.addClass("active")}collapse_previous_level_nodes(e){var t=$('[id="'+e.parent_id+'"]').parent().parent().children("li"),a=void 0;t.each(function(){(a=$(this).find(".node-card")).hasClass("active-path")||a.addClass("collapsed")})}refresh_connectors(e){var t=this;e&&($('path[data-parent="'+e+'"]').remove(),frappe.run_serially([function(){return t.get_child_nodes(e)},function(a){a&&$.each(a,function(a,n){t.add_connector(e,n.id)})}]))}setup_node_click_action(e){var t=this,a=$('[id="'+e.id+'"]');a.click(function(){t.selected_node.parent_id===e.parent_id?t.collapse_node():a.is(":visible")&&(a.hasClass("collapsed")||a.hasClass("active-path"))&&(t.remove_levels_after_node(e),t.remove_orphaned_connectors()),t.expand_node(e)})}setup_edit_node_action(e){var t=$('[id="'+e.id+'"]'),a=this;t.find(".btn-edit-node").click(function(){frappe.set_route("Form",a.doctype,e.id)})}remove_levels_after_node(e){var t=this,a=$('[id="'+e.id+'"]').parent().parent().parent().index();(a=$(".hierarchy > li:eq("+a+")")).nextAll("li").remove();var n=a.find(".node-card"),i=void 0;$.each(n,function(e,a){(i=t.nodes[a.id]).expanded=0,i.$children=void 0}),n.removeClass("collapsed active-path")}remove_orphaned_connectors(){var e=$("#connectors > path");$.each(e,function(e,t){var a=$(t).data("parent"),n=$(t).data("child");$('[id="'+a+'"]').length&&$('[id="'+n+'"]').length||$(t).remove()})}},erpnext.HierarchyChartMobile=class{constructor(e,t,a){this.page=t.page,this.method=a,this.doctype=e,this.page.main.css({"min-height":"300px","max-height":"600px",overflow:"auto",position:"relative"}),this.page.main.addClass("frappe-card"),this.nodes={},this.setup_node_class()}setup_node_class(){var e=this;this.Node=class{constructor(t){t.id,t.parent,t.parent_id,t.image,t.name,t.title,t.expandable,t.connections,t.is_root;$.extend(this,arguments[0]),this.expanded=0,e.nodes[this.id]=this,e.make_node_element(this),e.setup_node_click_action(this),e.setup_edit_node_action(this)}}}make_node_element(e){var t=frappe.render_template("node_card",{id:e.id,name:e.name,title:e.title,image:e.image,parent:e.parent_id,connections:e.connections,is_mobile:!0});e.parent.append(t),e.$link=$('[id="'+e.id+'"]'),e.$link.addClass("mobile-node")}show(){var e=this;if(!$('[data-fieldname="company"]').length){var t=this.page.add_field({fieldtype:"Link",options:"Company",fieldname:"company",placeholder:__("Select Company"),default:frappe.defaults.get_default("company"),only_select:!0,reqd:1,change:function(){e.company=void 0,t.get_value()&&e.company!=t.get_value()&&(e.company=t.get_value(),e.make_svg_markers(),e.$sibling_group&&e.$sibling_group.remove(),e.$sibling_group=$('<div class="sibling-group mt-4 mb-4"></div>'),e.page.main.append(e.$sibling_group),e.setup_hierarchy(),e.render_root_nodes())}});t.refresh(),$('[data-fieldname="company"]').trigger("change")}}make_svg_markers(){$("#arrows").remove(),this.page.main.prepend('\n\t\t\t<svg id="arrows" width="100%" height="100%">\n\t\t\t\t<defs>\n\t\t\t\t\t<marker id="arrowhead-active" viewBox="0 0 10 10" refX="3" refY="5" markerWidth="6" markerHeight="6" orient="auto" fill="var(--blue-500)">\n\t\t\t\t\t\t<path d="M 0 0 L 10 5 L 0 10 z"></path>\n\t\t\t\t\t</marker>\n\t\t\t\t\t<marker id="arrowhead-collapsed" viewBox="0 0 10 10" refX="3" refY="5" markerWidth="6" markerHeight="6" orient="auto" fill="var(--blue-300)">\n\t\t\t\t\t\t<path d="M 0 0 L 10 5 L 0 10 z"></path>\n\t\t\t\t\t</marker>\n\n\t\t\t\t\t<marker id="arrowstart-active" viewBox="0 0 10 10" refX="3" refY="5" markerWidth="8" markerHeight="8" orient="auto" fill="var(--blue-500)">\n\t\t\t\t\t\t<circle cx="4" cy="4" r="3.5" fill="white" stroke="var(--blue-500)"/>\n\t\t\t\t\t</marker>\n\t\t\t\t\t<marker id="arrowstart-collapsed" viewBox="0 0 10 10" refX="3" refY="5" markerWidth="8" markerHeight="8" orient="auto" fill="var(--blue-300)">\n\t\t\t\t\t\t<circle cx="4" cy="4" r="3.5" fill="white" stroke="var(--blue-300)"/>\n\t\t\t\t\t</marker>\n\t\t\t\t</defs>\n\t\t\t\t<g id="connectors" fill="none">\n\t\t\t\t</g>\n\t\t\t</svg>')}setup_hierarchy(){$("#connectors").empty(),this.$hierarchy&&this.$hierarchy.remove(),this.$sibling_group&&this.$sibling_group.empty(),this.$hierarchy=$('<ul class="hierarchy-mobile">\n\t\t\t\t<li class="root-level level"></li>\n\t\t\t</ul>'),this.page.main.append(this.$hierarchy)}render_root_nodes(){var e=this;frappe.call({method:e.method,args:{company:e.company}}).then(function(t){if(t.message.length){var a=e.$hierarchy.find(".root-level");a.empty(),$.each(t.message,function(t,n){return new e.Node({id:n.id,parent:a,parent_id:void 0,image:n.image,name:n.name,title:n.title,expandable:!0,connections:n.connections,is_root:!0})})}})}expand_node(e){var t=this.selected_node&&this.selected_node.id===e.id;if(this.set_selected_node(e),this.show_active_path(e),this.$sibling_group){var a=this.$sibling_group.find(".node-group").attr("data-parent");void 0!==e.parent_id&&e.parent_id!=a&&this.$sibling_group.empty()}if(!t){this.refresh_connectors(e.parent_id,e.id);var n=$('[id="'+e.parent_id+'"]').attr("data-parent");this.refresh_connectors(n,e.parent_id)}if(e.expandable&&!e.expanded)return this.load_children(e)}collapse_node(){var e=this,t=this.selected_node;if(t.expandable&&t.$children){t.$children.hide(),t.expanded=0;var a=t.$link.parent();a.prepend('<div class="collapsed-level d-flex flex-row"></div>'),a.find(".collapsed-level").append(t.$link),frappe.run_serially([function(){return e.get_child_nodes(t.parent_id,t.id)},function(a){return e.get_node_group(a,t.parent_id)},function(e){return a.find(".collapsed-level").append(e)},function(){return e.setup_node_group_action()}])}}show_active_path(e){$('[id="'+e.parent_id+'"]').addClass("active-path")}load_children(e){var t=this;frappe.run_serially([function(){return t.get_child_nodes(e.id)},function(a){return t.render_child_nodes(e,a)}])}get_child_nodes(e,t){void 0===t&&(t=null);var a=this;return new Promise(function(n){frappe.call({method:a.method,args:{parent:e,company:a.company,exclude_node:t}}).then(function(e){return n(e.message)})})}render_child_nodes(e,t){var a=this;e.$children||(e.$children=$('<ul class="node-children"></ul>').hide().appendTo(e.$link.parent()),e.$children.empty(),t&&$.each(t,function(t,n){a.add_node(e,n),$('[id="'+n.id+'"]').addClass("active-child"),setTimeout(function(){a.add_connector(e.id,n.id)},250)})),e.$children.show(),e.expanded=1}add_node(e,t){var a=$('<li class="child-node"></li>');return new this.Node({id:t.id,parent:a.appendTo(e.$children),parent_id:e.id,image:t.image,name:t.name,title:t.title,expandable:t.expandable,connections:t.connections,children:void 0})}add_connector(e,t){var a=document.getElementById(""+e),n=document.getElementById(""+t),i=document.createElementNS("http://www.w3.org/2000/svg","path"),r=void 0;$('[id="'+e+'"]').hasClass("active")?r=this.get_connector_for_active_node(a,n):$('[id="'+e+'"]').hasClass("active-path")&&(r=this.get_connector_for_collapsed_node(a,n)),i.setAttribute("d",r),this.set_path_attributes(i,e,t),document.getElementById("connectors").appendChild(i)}get_connector_for_active_node(e,t){var a=e.offsetLeft+20,n=e.offsetTop+e.offsetHeight,i=t.offsetLeft-5,r=t.offsetTop+t.offsetHeight/2;return"M"+a+","+n+" L"+a+","+(r-10)+" a10,10 1 0 0 10,10 L"+i+","+r}get_connector_for_collapsed_node(e,t){return"M"+(e.offsetLeft+20)+","+(e.offsetTop+e.offsetHeight)+" L"+(t.offsetLeft+20)+","+t.offsetTop}set_path_attributes(e,t,a){e.setAttribute("data-parent",t),e.setAttribute("data-child",a);var n=$('[id="'+t+'"]');n.hasClass("active")?(e.setAttribute("class","active-connector"),e.setAttribute("marker-start","url(#arrowstart-active)"),e.setAttribute("marker-end","url(#arrowhead-active)")):n.hasClass("active-path")&&e.setAttribute("class","collapsed-connector")}set_selected_node(e){this.selected_node&&this.selected_node.$link.removeClass("active"),this.selected_node=e,e.$link.addClass("active")}setup_node_click_action(e){var t=this,a=$('[id="'+e.id+'"]');a.click(function(){var n=void 0;e.is_root?(n=$(this).detach(),t.$hierarchy.empty(),$("#connectors").empty(),t.add_node_to_hierarchy(n,e)):a.is(":visible")&&a.hasClass("active-path")?(t.remove_levels_after_node(e),t.remove_orphaned_connectors()):(n=$(this).detach(),t.add_node_to_hierarchy(n,e),t.collapse_node()),t.expand_node(e)})}setup_edit_node_action(e){var t=$('[id="'+e.id+'"]'),a=this;t.find(".btn-edit-node").click(function(){frappe.set_route("Form",a.doctype,e.id)})}setup_node_group_action(){var e=this;$(".node-group").on("click",function(){var t=$(this).attr("data-parent");"undefined"===t?(e.setup_hierarchy(),e.render_root_nodes()):e.expand_sibling_group_node(t)})}add_node_to_hierarchy(e,t){this.$hierarchy.append('<li class="level"></li>'),e.removeClass("active-child active-path"),this.$hierarchy.find(".level:last").append(e);var a=this.nodes[t.id];a.expanded=0,a.$children=void 0,this.nodes[t.id]=a}get_node_group(e,t,a){var n=this;void 0===a&&(a=!0);var i=e.slice(0,2),r=e.slice(2),d=i.map(function(e){return n.get_avatar(e)}).join("");if(1===r.length){var o=r[0];d+=this.get_avatar(o)}else r.length>1&&(d="\n\t\t\t\t"+d+'\n\t\t\t\t<span class="avatar avatar-small">\n\t\t\t\t\t<div class="avatar-frame standard-image avatar-extra-count"\n\t\t\t\t\t\ttitle="'+r.map(function(e){return e.name}).join(", ")+'">\n\t\t\t\t\t\t+'+r.length+"\n\t\t\t\t\t</div>\n\t\t\t\t</span>\n\t\t\t");if(d){var s=$('<div class="node-group card cursor-pointer" data-parent='+t+'>\n\t\t\t\t\t<div class="avatar-group right overlap">\n\t\t\t\t\t\t'+d+"\n\t\t\t\t\t</div>\n\t\t\t\t</div>");return a&&s.addClass("collapsed"),s}return null}get_avatar(e){return'<span class="avatar avatar-small" title="'+e.name+'">\n\t\t\t<span class="avatar-frame" src='+e.image+' style="background-image: url('+e.image+')"></span>\n\t\t</span>'}expand_sibling_group_node(e){var t=this,a=this.nodes[e],n=a.$link;n.removeClass("active-child active-path"),a.expanded=0,a.$children=void 0,this.nodes[n.id]=a,frappe.run_serially([function(){return t.get_child_nodes(a.parent_id,a.id)},function(e){return t.get_node_group(e,a.parent_id,!1)},function(e){e&&t.$sibling_group.empty().append(e)},function(){return t.setup_node_group_action()},function(){return t.reattach_and_expand_node(n,a)}])}reattach_and_expand_node(e,t){var a=e.detach();this.$hierarchy.empty().append('\n\t\t\t<li class="level"></li>\n\t\t'),this.$hierarchy.find(".level").append(a),$("#connectors").empty(),this.expand_node(t)}remove_levels_after_node(e){var t=$('[id="'+e.id+'"]').parent().parent().index();(t=$(".hierarchy-mobile > li:eq("+t+")")).nextAll("li").remove();var a=this.nodes[e.id],n=t.find('[id="'+e.id+'"]').detach();n.removeClass("active-child active-path"),a.expanded=0,a.$children=void 0,t.empty().append(n)}remove_orphaned_connectors(){var e=$("#connectors > path");$.each(e,function(e,t){var a=$(t).data("parent"),n=$(t).data("child");$('[id="'+a+'"]').length&&$('[id="'+n+'"]').length||$(t).remove()})}refresh_connectors(e,t){e&&($('path[data-parent="'+e+'"]').remove(),this.add_connector(e,t))}}}(html2canvas);
//# sourceMappingURL=hierarchy-chart.min.js.map
